#!/bin/sh

PROGNAME=pm2load

error() # msg
{
    echo $*
    exit 1
}

usage() # exit_code
{
    cat <<EOF
Usage: $PROGNAME { option } command

  option:
    -f name : Use flavor named "name" (default=\$PM2_FLAVOR or default)
    -d      : Run command in debug mode (not supported by all implementations)
    -c name : Use console named "name"
    -h : Display this help message
EOF
    exit $1
}

ambiguity() # prog
{
    prog=$1
    shift

    echo "Error: multiple exec files found." >&2
    echo "Please remove ambiguity by using one the following:" >&2

    for p in `pm2which -p $prog` ; do
	echo "   $PROGNAME $p ..."
    done

    exit 1
}


# Programme principal

PM2_FLAVOR=${PM2_FLAVOR:-default}
export PM2_FLAVOR

PM2_CONSOLE=""
export PM2_CONSOLE

PM2_DEBUG=off
export PM2_DEBUG

while [ $# -gt 0 ]; do
    case $1 in
	-f)
	    shift
	    PM2_FLAVOR="$1"
	    shift
	    ;;
	-d)
	    shift
	    PM2_DEBUG=on
	    ;;
	-c)
	    shift
	    PM2_CONSOLE="$1"
	    shift
	    ;;
	-h)
	    usage 0
	    ;;
	--)
	    shift
	    break
	    ;;
	*)
	    break
	    ;;
    esac
done

[ -n "$*" ] || usage 1

# Sauvegarde de la commande et des arguments
prog=$1
shift

prog_args="$@"

# Récupération de (des) chemin(s) d'accès au fichier exécutable

set --  --source-mode $prog
. ${PM2_ROOT}/bin/pm2which

if [ $_PM2WHICH_NB_FOUND -gt 1 ] ; then
    ambiguity $prog
fi

# On hérite du même coup du chemin d'accès au chargeur

[ -x $_PM2WHICH_LOADER ] || error "Fatal Error: \"$_PM2WHICH_LOADER\" exec file not found!"

case $_PM2WHICH_LOADER in
    *conf_not_needed)
	# No need to try to access the pm2 conf file
	;;
    *)
	# Récupération du chemin d'accès au fichier de config des machines
	set --  --source-mode
	. ${PM2_ROOT}/bin/pm2-conf-file

	[ -f $PM2_CONF_FILE ] || pm2conffile_error "Error: PM2 is not yet configured this flavor (please run pm2conf)."
	;;
esac

exec $_PM2WHICH_LOADER $_PM2WHICH_RESULT $prog_args
