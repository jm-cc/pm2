#!/usr/bin/env pm2-sh
#-*-sh-*-
###########
#
# Xwindow mode loader

# $1... = command and arguments

prog=$1
shift
args=${@:+"$@"}

title="$prog.${HOST:-`hostname`}"

PS="ps -A"
ARCH=`uname -m`
if [ "$ARCH" = "Power Macintosh" ]
then
  PS="ps -U $USER"
fi

procs=$($PS | grep pm2-logload | sort | sed 's/^[^0-9]*\([0-9]*\).*$/\1 /')
if [ "$procs" != "" ] ; then
    set $procs
else
    set ""
fi
num='0'

while [ $# -gt 0 ]
do
    [ $$ == "$1" ] && break
    shift
    num=`expr $num + 1`
done

logfile="/tmp/pm2log-${USER:-nobody}-${num}"
echo $logfile

[ -f $logfile ] && rm -f $logfile

echo $title > $logfile

pm2-wrapper $prog $args </dev/null >>$logfile 2>&1
