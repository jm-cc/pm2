
# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (see AUTHORS file)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


compile_leonie()
{
	echo "Compiling Leonie"
	(cd ${PM2_OBJROOT}/leonie ; make FLAVOR=leonie)
}

# args: loop variable
initialize_bench()
{
	dev=$1
	shift
	
	if [ ! -f ${bench_setting_file} ]; then
		echo "bench setting file \"${bench_setting_file}\" not found"
		return 1
	fi

        # Configuration
	line=`grep \\^${dev} ${bench_setting_file}`

	if [ "_${line}" == "_" ]; then
		echo "device ${dev} not found in setting file"
		return 1
	fi

	OLD_IFS=$IFS
	IFS=":"
	set $line
        net="$2"
        hosts="$3"
	IFS=$OLD_IFS

        # Creation de la flavor
        eval ${PM2_OBJROOT}/bin/pm2-flavor set --flavor=\"$flavor\" \
         --ext=\"\" \
         --modules=\"init mad3 ntbx tbx\" \
         --init=\"opt\" \
         --mad3=\"opt ${dev}\" \
         --ntbx=\"opt\" \
         --tbx=\"opt\" \
         --common=\"opt\" \
         --all=\"build_static\"

	# Creation du fichier de configuration de Leonie
	rm -f $leo_cfg_file

	sed -e "s/HOSTS/${hosts}/" -e "s/NET/${net}/" > $leo_cfg_file <<END
application : {
	networks : {
		channels : ({
			name : channel_1;
			net  : NET;
			hosts : (HOSTS);
		});
	};
};
END
	echo "Device = ${dev}, network = ${net}, hosts = ${hosts}"
}

# args: -
run_bench()
{
	_run_appli=$1
	shift

	_run_flavor=$1
	shift

	# wait for NFS to propagate the new compiled program
	sleep 10

	${PM2_SRCROOT}/bin/leonie --flavor=$flavor --appli=$prog --net=${LEONIE_NETWORK_FILE:-"${PM2_ROOT}/leonie/examples/networks.cfg"} $leo_args $leo_cfg_file $leo_appli_args
}

# args: loop variable
finalize_bench()
{
	true
}

####################

# Compilation du lanceur leonie
compile_leonie 2>&1 | sed -e 's/^/..../'

#

