#!/bin/sh

# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (pm2-dev@listes.ens-lyon.fr)
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


#
# madspawn attend les paramètres suivants :
# $1 : machine serveur
# $2 : confsize
# $3 : port serveur...
# $4 : console
# $5 à ... : executable a lancer et arguments
#

# Just in case MAD1_ROOT is not defined
MAD1_ROOT=${MAD1_ROOT-${PM2_ROOT}/mad1}
export MAD1_ROOT

# Note: PM2_CONF_FILE is inherited

serverhost=$1
shift
confsize=$1
shift
port=$1
shift
MAD_CONSOLE=$1
shift

prog="$1"
shift
args=""
while [ $# -gt 0 ]; do
    args="$args '$1'"
    shift
done

mynumber=1
nbmachines=`cat ${PM2_CONF_FILE} | wc -w`

if [ -z "$MAD_DEBUG" ]; then
    MAD_DEBUG=off
fi

if [ -z "$DISPLAY" ]; then
    DISPLAY=:0
fi

if [ "$MAD_CONSOLE" = "no" ]; then
    trueconfsize=$confsize
else
    trueconfsize=`expr $confsize - 1`
fi

while [ $mynumber -lt $trueconfsize ]; do
    plusun=`expr $mynumber % $nbmachines + 1`
    host=`head -$plusun ${PM2_CONF_FILE} | tail -1`
    ${PM2_RSH:-rsh} -n $host ${MAD1_ROOT}/bin/tcp/madstart "$PM2_CONF_FILE" "$DISPLAY" "$MAD_DEBUG" $confsize $mynumber $host $port $serverhost $prog $args &
    mynumber=`expr $mynumber + 1`
done

if [ ! $MAD_CONSOLE = "no" ]; then
    host=`head -1 ${PM2_CONF_SIZE}`
    ${PM2_RSH:-rsh} -n $host ${MAD1_ROOT}/bin/tcp/madstartcons "$PM2_CONF_FILE" "$DISPLAY" "$MAD_CONSOLE" $confsize $mynumber $host $port $serverhost &
fi
