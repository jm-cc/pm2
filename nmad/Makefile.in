# autoconf-based makefile for nmad

srcdir := @srcdir@
VPATH  := $(srcdir)

include @puk_root@/etc/common_vars.mk

TARGET_BIN = #sampling/sampling-prog
TARGET_LIB = libnmad.so
TARGET_MOD =
SUBDIRS =

INSTALL_BIN       = $(TARGET_BIN) bin/nmad-driver-conf bin/nmad-strategy-conf bin/nmad-sample
INSTALL_LIB       = $(TARGET_LIB)
INSTALL_INCLUDE  += $(wildcard $(srcdir)/include/*.h)
INSTALL_PKGCONFIG = nmad.pc

INSTALL_PREFIX := @nmad_root@
INSTALL_INCLUDE_PATH := $(INSTALL_PREFIX)/include

TARGETS = subdirs $(TARGET_BIN) $(TARGET_LIB) $(TARGET_MOD)

CFLAGS  := @NMAD_CFLAGS@ @NMAD_EXT_CFLAGS@ $(CFLAGS)
LDFLAGS := @NMAD_LDFLAGS@ $(LDFLAGS)
LIBS    := @NMAD_EXT_LIBS@ $(LIBS)

NMAD_DRIVERS    = @nmad_drivers@
NMAD_STRATEGIES = @nmad_strategies@
NMAD_INTERFACES = @nmad_interfaces@

# compute flags and directories from options
SRC_DIRS += src ccs
SRC_DIRS += $(foreach drv,   $(NMAD_DRIVERS),    drivers/$(drv) )
SRC_DIRS += $(foreach strat, $(NMAD_STRATEGIES), strategies/strat_$(strat) )
SRC_DIRS += $(foreach int,   $(NMAD_INTERFACES), interfaces/$(int)/src )
CFLAGS   += $(foreach int,   $(NMAD_INTERFACES), -I$(srcdir)/interfaces/$(int)/include )
INSTALL_INCLUDE += $(foreach int, $(NMAD_INTERFACES), $(wildcard $(srcdir)/interfaces/$(int)/include/*.h) )
INSTALL_BIN += $(foreach int, $(NMAD_INTERFACES), $(wildcard $(srcdir)/interfaces/$(int)/bin/*) )

# make multiple directories fit inside a single module
SRC_FILES := $(foreach d, $(SRC_DIRS), $(wildcard $(srcdir)/$(d)/*.c ))
OBJ_FILES := $(patsubst $(srcdir)/%.c, ./%.pic.o, $(SRC_FILES))
DEP_FILES := $(patsubst $(srcdir)/%.c, ./%.d, $(SRC_FILES))
CLEAN_MORE += $(OBJ_FILES) $(DEP_FILES)
TARGET_DEP += $(DEP_FILES)

include @puk_root@/etc/common_rules.mk

-include $(DEP_FILES)

libnmad.so: LIBS += -lrt
libnmad.so: $(OBJ_FILES)


$(TARGET_BIN): LIBS += -L. -lnmad
$(TARGET_BIN): %: %.pic.o $(TARGET_LIB)

