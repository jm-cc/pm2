#!/usr/bin/env pm2-sh
#-*-sh-*-

# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (see AUTHORS file)
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


if [ "`echo -n`" != "-n" ] ; then
	ECHO='echo -n .'
elif [ -x /usr/bin/printf ] ; then
	ECHO='printf .'
else
	ECHO='echo .'
fi

if [ "${PM2_ROOT}" = "" ]; then
    echo "PM2_ROOT is not defined"
    exit 1
fi

. ${PM2_ROOT}/bin/pm2-vars

make_ln() # Create $3 pointing on $2 in the directory $1
{
    $ECHO
    cd $1
    if [ -z "$3" ]; then
	LINK=`basename $2`
    else
	LINK=$3
    fi
    if [ -z "${2##\/*}" ]; then
        echo "WARNING: absolute path $2 does not allow moving sources"
    fi
    if [ ! -h "$LINK" ]; then
	ln -s $2 $LINK
    fi
}

echo "Recreating symlink..."
# module links
echo
echo Modules
if [ ! -d ${PM2_ROOT}/modules ] ; then
    mkdir ${PM2_ROOT}/modules
fi
for module in appli common dsm ezflavor generic init leonie leoparse \
	mad3 nmad marcel xpaulette ntbx pm2 profile stackalign tbx puk
	do
   make_ln ${PM2_ROOT}/modules ../$module `basename $module`
done

# examples links
rm -f ${PM2_ROOT}/mad3/examples/cfgs ${PM2_ROOT}/mad3/examples/networks.cfg
make_ln ${PM2_ROOT}/mad3/examples ../../leonie/examples         cfgs
make_ln ${PM2_ROOT}/mad3/examples ../../leonie/examples/networks.cfg

# architecture-specific directories for the storage of binaries, etc.

# Toolbox

# Mad I
#echo
#echo Madeleine I
#make_ln ${MAD1_ROOT}/ ../marcel/ARCHITECTURES ARCHITECTURES

#make_ln ${MAD1_ROOT}/source/ mpi mpi_bip
#make_ln ${MAD1_ROOT}/source/ mpi mpi_lam
#make_ln ${MAD1_ROOT}/source/ mpi mpi_sgi
#make_ln ${MAD1_ROOT}/source/ mpi mpi_sp2

# Mad II
#echo
#echo Madeleine II
#make_ln ${MAD2_ROOT}/ ../marcel/ARCHITECTURES ARCHITECTURES

# DSM
#echo
#echo DSM
#make_ln ${DSM_ROOT}/ ../marcel/ARCHITECTURES ARCHITECTURES

if [ "$1" != "--nooptionsets" ]; then
    # Fabrication des catégories d'options
    ${PM2_ROOT}/bin/pm2-make-option-sets
fi

echo
