#!/usr/bin/env pm2sh

# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (see AUTHORS file)
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


PROGNAME=pm2load

_pm2load_error() # msg
{
    echo $*
    exit 1
}

_pm2load_usage() # exit_code
{
    cat <<EOF
Usage: $PROGNAME { option } command

  option:
    -f name  : Use flavor named "name" (default=\$PM2_FLAVOR or default)
    -d       : Run command through gdb
    -vg      : Run command through valgrind
    --numactl [n]: Run command through numactl [default: n=0]
    -t       : Run command through strace
    -p cmd   : Run pre-script command (e.g. numactl)
    -s       : Run scripts in debug mode
    -c name  : Use console named "name"
    -l       : Also generate a log file on first node
    -L       : As '-l' but do not display the log file
    -u       : Use local flavor (re-run pm2-config on each node)
    --protocol name : Use protocol named "name"
    -h       : Display this help message
EOF
    exit $1
}

_pm2load_ambiguity() # prog
{
    _prog=$1
    shift

    echo "Error: multiple exec files found." >&2
    echo "Please remove ambiguity by using one the following:" >&2

    for _p in `pm2which -p $_prog` ; do
	echo "   $PROGNAME $_p ..."
    done

    exit 1
}

log()
{
    if [ -n "$PM2_SCRIPT_DEBUG" ]; then
	echo "$*" 1>&2
    fi
}

mad3()
{
    log "Args: ${prog_args[@]}"

    if [ -n "$PM2_PROTOCOL" ] ; then
        protocol="$PM2_PROTOCOL"
    else
        protocol=$_PM2CONFIG_PROTOCOLS
        nb_protocols=$(echo $protocol | wc -w)
        if [ "$nb_protocols" != 1 ] ; then
            _pm2load_error "Error: More than one protocol selected ($protocol ). You might use the parameter --protocol to select one protocol"
        fi
    fi
    protocol=`echo $protocol|tr -d ' '`
    log "Protocol: $protocol"

    dev=$protocol
    # dirty fix list for devices with multiple drivers
    case $protocol in
        tcpdg)
            dev='tcp'
            ;;
        *)
            echo 'default case'
            ;;
    esac
    log "Device: $dev"

    # Récupération du chemin d'accès au fichier de config des machines
    set --  --source-mode
    . ${PM2_ROOT}/bin/pm2-conf-file

    [ -f $PM2_CONF_FILE ] || _pm2load_error "Error: PM2 is not yet configured this flavor (please run pm2conf)."
    log "PM2 config file: ${PM2_CONF_FILE}"

    PM2_LEONIE_FILE="${PM2_CONF_FILE}.cfg"
    log "Leonie config file: ${PM2_LEONIE_FILE}"

    PM2_LEONIE_NETWORK_FILE=${PM2_LEONIE_NETWORK_FILE:-${LEONIE_NETWORK_FILE:-"${PM2_ROOT}/leonie/examples/networks.cfg"}}

    host_list=`cat ${PM2_CONF_FILE}`
    set ${PM2_LEONIE_NETWORK_FILE} $dev $host_list
    network_name=`. ${PM2_ROOT}/bin/leo-network`

    if [ "$network_name" == "Network not found" ] ; then
        _pm2load_error "Error: No network found for device $dev and hosts $host_list"
    fi

    new_list=""

    for i in $host_list
    do
	[ -z "$new_list" ] && new_list="${i}[0]" && continue
	k='0'
	for j in $new_list 
	do
	    [ $j != "${i}[${k}]" ] && continue
	    k=`expr $k + 1`
	done

	new_list="$new_list ${i}[${k}]"
    done

    tmp_list=`echo $new_list|tr ' ' ','`
    log "Host list: " $tmp_list

    [ -f $PM2_LEONIE_FILE ] && rm -f $PM2_LEONIE_FILE
    echo "application: {"                      >  $PM2_LEONIE_FILE
    echo "    networks: {"                     >> $PM2_LEONIE_FILE
    echo "        channels: {"                 >> $PM2_LEONIE_FILE
    echo "            name : pm2;"             >> $PM2_LEONIE_FILE
    echo "            net  : ${network_name};" >> $PM2_LEONIE_FILE
    echo "            hosts: (${tmp_list});"   >> $PM2_LEONIE_FILE
    echo "        };"                          >> $PM2_LEONIE_FILE
    echo "    };"                              >> $PM2_LEONIE_FILE
    echo "};"                                  >> $PM2_LEONIE_FILE

    [ "$PM2_DEBUG" = "on" ] && PM2_XMODE="on"

    pm2load_args=""
    [ "$PM2_DEBUG" = "on" ]           && pm2load_args="${pm2load_args} -d"
    [ "$PM2_DEBUG" = "off" ]          && pm2load_args="${pm2load_args} --d"
    [ "$PM2_VALGRIND" = "on" ]        && pm2load_args="${pm2load_args} -vg"
    [ "$PM2_VALGRIND" = "off" ]       && pm2load_args="${pm2load_args} --vg"
    [ "$PM2_XMODE" = "on" ]           && pm2load_args="${pm2load_args} -x"
    [ "$PM2_XMODE" = "off" ]          && pm2load_args="${pm2load_args} --x"
    [ "$PM2_PMODE" = "on" ]           && pm2load_args="${pm2load_args} -p"
    [ "$PM2_PMODE" = "off" ]          && pm2load_args="${pm2load_args} --p"
    [ "$PM2_LOGS_ON_NODE_0" = "on" ]  && pm2load_args="${pm2load_args} -l"
    [ "$PM2_LOGS_ON_NODE_0" = "off" ] && pm2load_args="${pm2load_args} --l"

    if [ "$PM2_NUMACTL" != "off" ] ; then
        pm2load_args="${pm2load_args} --numactl=$PM2_NUMACTL"
    fi

    ${PM2_ROOT}/bin/leonie --env="PM2_EXPORT=${PM2_EXPORT} LD_LIBRARY_PATH=${PM2_LD_LIBRARY_PATH}${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}" "--appli=${PM2_PROG_NAME}" "--flavor=${PM2_FLAVOR}" "--net=${PM2_LEONIE_NETWORK_FILE}" ${pm2load_args} $PM2_LEONIE_FILE "${prog_args[@]}"

    exit $?
}

# Programme principal
log "Running $*"

PM2_FLAVOR=${PM2_FLAVOR:-default}
export PM2_FLAVOR

PM2_CONSOLE=""

PM2_DEBUG=off
PM2_VALGRIND=off
PM2_NUMACTL=off
PM2_LOGS_ON_NODE_0=off
PM2_USE_LOCAL_FLAVOR=off
PM2_XMODE=off
PM2_PMODE=off

while [ $# -gt 0 ]; do
    case $1 in
	-f|--flavor)
	    shift
	    PM2_FLAVOR="$1"
	    shift
	    ;;
	--protocol)
	    shift
	    PM2_PROTOCOL="$1"
	    shift
	    ;;
	-d|--debug)
	    shift
	    PM2_DEBUG=on
	    ;;
	-vg|--valgrind)
	    shift
	    PM2_VALGRIND=on
	    ;;
	--numactl)
	    shift
            x=$(expr $1 + 0 2>/dev/null)
            if [ $? -ne 0 ] ; then
                x=0
            else
                shift
            fi
	    PM2_NUMACTL=$x
	    PM2_SCRIPT="numactl --cpubind=$x --membind=$x"
	    ;;
	-t|--trace)
	    shift
	    PM2_STRACE=on
	    ;;
	--prescript)
	    shift
	    PM2_SCRIPT="$1"
	    shift
	    ;;
	-s|--debug)
	    shift
	    PM2_SCRIPT_DEBUG=on
	    ;;
	-c|--console)
	    shift
	    PM2_CONSOLE="$1"
	    shift
	    ;;
	-l|--log)
	    shift
	    PM2_LOGS_ON_NODE_0=on
	    ;;
	-L)
	    shift
	    PM2_LOGS_ON_NODE_0=only
	    ;;
# begin MadIII only
	--l) # Logs off
	    shift
	    PM2_LOGS_ON_NODE_0=off
	    ;;
	--d) # Debug off
	    shift
	    PM2_DEBUG=off
	    ;;
	--vg) # Valgrind off
	    shift
	    PM2_VALGRIND=off
	    ;;
	--t) # Strace off
	    shift
	    PM2_STRACE=off
	    ;;
	-x) # XTerm mode on
	    shift
	    PM2_XMODE=on
	    ;;
	--x) # XTerm mode off
	    shift
	    PM2_XMODE=off
	    ;;
	-p) # Pause mode on
	    shift
	    PM2_PMODE=on
	    ;;
	--p) # Pause mode off
	    shift
	    PM2_PMODE=off
	    ;;
# end MadIII only
	-u|--use-local-flavor)
	    shift
	    PM2_USE_LOCAL_FLAVOR=on
	    ;;
	-h|--help)
	    _pm2load_usage 0
	    ;;
	--)
	    shift
	    break
	    ;;
	-*)
	    _pm2load_usage 1
	    ;;
	*)
	    break
	    ;;
    esac
done

[ -n "$*" ] || _pm2load_usage 1


# Initialisation des arguments passés à pm2-pre-script.sh
_prescript_args=""


# Variables automatiquement exportées
PM2_EXPORT=${PM2_EXPORT:+${PM2_EXPORT}:}PM2_LD_LIBRARY_PATH:PM2_FLAVOR

if [ "$PM2_SCRIPT_DEBUG" = on ]; then
    export PM2_SCRIPT_DEBUG
    _prescript_args="$_prescript_args --script-debug"
fi

# Sauvegarde de la commande et des arguments
PM2_PROG_NAME=$1
export PM2_PROG_NAME
shift

prog_args=(${@:+"$@"})

if [ "$PM2_USE_LOCAL_FLAVOR" = off ] ; then

    PM2_EXPORT=${PM2_EXPORT:+${PM2_EXPORT}:}PM2_CONF_FILE

    # Récupération de (des) chemin(s) d'accès au fichier exécutable

    set --  --source-mode $PM2_PROG_NAME
    . ${PM2_ROOT}/bin/pm2which

    if [ $_PM2WHICH_NB_FOUND -gt 1 ] ; then
	_pm2load_ambiguity $PM2_PROG_NAME
    fi

    PM2_CMD_NAME="$_PM2WHICH_RESULT"
    export PM2_CMD_NAME

    # Librairies dynamiques (LD_PRELOAD)
    if [ -n "$_PM2CONFIG_PRELOAD" ]; then
	_prescript_args="$_prescript_args --preload $_PM2CONFIG_PRELOAD"
    fi

    # LD library path
    PM2_LD_LIBRARY_PATH="$_PM2CONFIG_LD_LIBRARY_PATH"

    # Mad3 special case
    case " $_PM2CONFIG_MODULES " in
    *\ mad3\ *)
	# Mad III mode
	log "Mad III selected"
	mad3 "${prog_args[@]}"
	exit $?
	;;
    *)
	;;
    esac

    if [ "$_PM2CONFIG_LAUNCHER" == "leonie" ] ; then
        log "Leonie selected"
	mad3 "${prog_args[@]}"
	exit $?               
    fi

else # USE_LOCAL_FLAVOR

    PM2_CMD_NAME="$PM2_PROG_NAME"
    export PM2_CMD_NAME

# Pour obtenir $_PM2CONFIG_LOADER...
    set -- --source-mode
    . ${PM2_ROOT}/bin/pm2-config

    _prescript_args="$_prescript_args --use-local-flavor"

fi

# Chemin d'accès au chargeur
[ -x $_PM2CONFIG_LOADER ] || _pm2load_error "Fatal Error: \"$_PM2CONFIG_LOADER\" exec file not found!"

case $_PM2CONFIG_LOADER in
    *conf_not_needed)
	# No need to try to access the pm2 conf file
	;;
    *)
	# Récupération du chemin d'accès au fichier de config des machines
	set --  --source-mode
	. ${PM2_ROOT}/bin/pm2-conf-file

	[ -f $PM2_CONF_FILE ] || _pm2load_error "Error: PM2 is not yet configured this flavor (please run pm2conf)."
	;;
esac

# Variable DISPLAY
#case "_${DISPLAY}" in
#    _) DISPLAY=`uname -n`:0.0 ;;
#    _:*) DISPLAY=`uname -n`${DISPLAY} ;;
#    *) ;;
#esac

# Arguments à passer à pm2-pre-script.sh

# Debug
if [ "$PM2_DEBUG" = on ]; then
    _prescript_args="$_prescript_args --debug"
fi

if [ "$PM2_VALGRIND" = on ]; then
    _prescript_args="$_prescript_args --valgrind"
fi

if [ "$PM2_STRACE" = on ]; then
    _prescript_args="$_prescript_args --strace"
fi

if [ -n "$PM2_SCRIPT" ]; then
    _prescript_args="$_prescript_args --prescript \"$PM2_SCRIPT\""
fi

_old_ifs="$IFS"
_ifs_not_set=${IFS-yes}
IFS=":"
set $PM2_EXPORT
IFS=" "
if [ "$_ifs_not_set" = yes ]; then
    unset IFS
else
    IFS="$_old_ifs"
fi

# Variables à exporter
for v in $*; do
    eval _val=\"\$$v\"
    log "Exporting $v with value '$_val'"
    if [ -n "$_val" ]; then
	_prescript_args="$_prescript_args --export $v \"$_val\""
    fi
done

if [ "$PM2_USE_LOCAL_FLAVOR" = on ]; then
    PM2_PRE_SCRIPT=pm2-pre-script.sh
else
    PM2_PRE_SCRIPT=${PM2_ROOT}/bin/pm2-pre-script.sh
fi

if [ "$PM2_LOGS_ON_NODE_0" = "on" ]; then
    log "Executing: $_PM2CONFIG_LOADER ${PM2_PRE_SCRIPT} $_prescript_args -- \
	$PM2_CMD_NAME ${prog_args[@]}"
    eval $_PM2CONFIG_LOADER ${PM2_PRE_SCRIPT} $_prescript_args -- \
	$PM2_CMD_NAME "${prog_args[@]}" 2>&1 | tee /tmp/${USER}-pm2log-0
    exit 0
elif [ "$PM2_LOGS_ON_NODE_0" = "only" ]; then
    log "Executing: $_PM2CONFIG_LOADER ${PM2_PRE_SCRIPT} $_prescript_args -- \
        $PM2_CMD_NAME ${prog_args[@]}"
    eval $_PM2CONFIG_LOADER ${PM2_PRE_SCRIPT} $_prescript_args -- \
        $PM2_CMD_NAME "${prog_args[@]}" > /tmp/${USER}-pm2log-0 2>&1
    exit 0
else
    log "Executing: set -- ${PM2_PRE_SCRIPT} $_prescript_args -- \
        $PM2_CMD_NAME ${prog_args[@]}"
    log "Executing: . $_PM2CONFIG_LOADER"
    eval set -- ${PM2_PRE_SCRIPT} $_prescript_args -- \
	$PM2_CMD_NAME \"\${prog_args[@]}\"
    . $_PM2CONFIG_LOADER
fi
