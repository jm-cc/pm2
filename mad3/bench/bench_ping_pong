
# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (see AUTHORS file)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


compile_leonie()
{
	(cd ${PM2_ROOT}/leonie ; make FLAVOR=leonie)
}

# args: loop variable
initialize_bench()
{
	dev=$1
	shift
	
	if [ ! -f ${bench_setting_file} ]; then
		echo "bench setting file \"${bench_setting_file}\" not found"
		exit 1
	fi

        # Configuration
	line=`grep \\^${dev} ${bench_setting_file}`

	if [ "_${line}" == "_" ]; then
		echo "device ${dev} not found in setting file"
	fi

	OLD_IFS=$IFS
	IFS=":"
	set $line
        net="$2"
        hosts="$3"
	IFS=$OLD_IFS

        # Creation de la flavor
        eval ${PM2_ROOT}/bin/pm2-flavor set --flavor=\"$flavor\" \
         --ext=\"\" \
         --modules=\"init mad3 ntbx tbx\" \
         --init=\"opt\" \
         --mad3=\"opt ${dev}\" \
         --ntbx=\"opt\" \
         --tbx=\"opt\" \
         --common=\"opt\" \
         --all=\"build_static\"

	# Creation du fichier de configuration de Leonie
        _host_list=""
        for _h in $hosts ; do
            _host_list="${_host_list:+${_host_list}, }$_h"
        done

	rm -f $cfgfile

	sed -e "s/HOSTS/${_host_list}/" -e "s/NET/${net}/" > $cfgfile <<END
application : {
	networks : {
		channels : ({
			name : channel_1;
			net  : NET;
			hosts : (HOSTS);
		});
	};
};
END
}

# args: loop variable
finalize_bench()
{
	true
}

####################
# Verification et compilation du lanceur leonie
#leonie --help > /dev/null 2>&1 || compile_leonie
compile_leonie

flavor="bench_mad3"
cfgfile="/tmp/bench_mad3.cfg"
appdir="${PM2_ROOT}/mad3/examples"
prog="mad_bench_ping"
args="-w --x --p --l"
#loop="tcp gm mx quadrics"
loop="tcp"
bench_setting_file="${PM2_HOME:-${HOME}}/.pm2/bench/mad3"
#

