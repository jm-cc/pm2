
# -*-makefile-*-

# NewMadeleine
# Copyright (C) 2006 (see AUTHORS file)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

.PHONY: all vars libs clean

# toplevel rule
# ----
ifdef APP
all: $(APP)
else
all: libs
endif

# variable display rule
# ----
vars:
	@echo -e MODULES          \\t$(MODULES)
	@echo -e EMODULES         \\t$(EMODULES)
	@echo
	@echo -e MOD_CPPFLAGS     \\t$(MOD_CPPFLAGS)
	@echo -e MOD_INCDIRS      \\t$(MOD_INCDIRS)
	@echo -e MOD_SRCDIRS      \\t$(MOD_SRCDIRS)
	@echo -e MOD_CFLAGS       \\t$(MOD_CFLAGS)
	@echo -e MOD_LDFLAGS      \\t$(MOD_LDFLAGS)
	@echo -e MOD_ELIBS        \\t$(MOD_ELIBS)
	@echo -e MOD_PATHS        \\t$(MOD_PATHS)
	@echo
	@echo -e PM2_CFLAGS       \\t$(PM2_CFLAGS)
	@echo -e PM2_LDFLAGS      \\t$(PM2_LDFLAGS)
	@echo -e PM2_SYS          \\t$(PM2_SYS)
	@echo
	@echo -e CPPFLAGS         \\t$(CPPFLAGS)
	@echo -e CFLAGS           \\t$(CFLAGS)
	@echo -e LDFLAGS          \\t$(LDFLAGS)
	@echo -e LIBS_FLAGS       \\t$(LIBS)
	@echo -e LIBS_DEP         \\t$(LIBS_DEP)


# main rule for building all selected libs
# ----
#
# the foreach loops build a string on the following pattern:
# libx.a(m/a.o m/b.o m/c.o) libx.a(n/d.o n/e.o n/f.o) liby.a(...) ...
# - first loop is on the modules
# - second loop is on the source dirs of each module
# the list of .o is generated out of the .c files found in each directory
#
libs: $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),libnm$(M).a($(patsubst %.c,%.o,$(wildcard $(D)/*.c)))))

ifeq ($(CONFIG_VERBOSE), y)
#/////////////////////////////| Verbose version |/////////////////////////////#
# library making rule
# ----
(%): %
	$(AR) cr $@ $<

# single file application building rule
# ----
#
# Note: "%:%.o" and "%:c" disables the corresponding implicit rules
%:	%.c
%:	%.o
%:	%.o $(LIBS_DEP)
	$(CC) $(CPPFLAGS) $(CFLAGS) -o $@ $< $(LDFLAGS) $(LIBS)

# compiling rule
# ----
#
# Note: "%.o:%.c" disables the implicit rule which does not
# chain the rule %.d
#
%.o:	%.c
%.o:	%.c %.d
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

# dependency generation rule
# ----
%.d:	%.c
	set -e; rm -f $@; \
	$(CC) -MM $(CPPFLAGS) $< | \
	sed 's,:,: $(MAKE_CONF) $(BUILD_CFG),' | \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@;

# cleaning rule
# ----
clean:
	rm -vf $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.o,$(wildcard $(D)/*.c))))
	rm -vf $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.d,$(wildcard $(D)/*.c))))
	rm -vf $(foreach M,$(EMODULES),libnm$(M).a)
	rm -vf $(APP) $(patsubst %,%.o,$(APP)) $(patsubst %,%.d,$(APP))

else
#/////////////////////////////|  Terse version  |/////////////////////////////#

# library making rule
# ----
(%): %
	@echo -e "  [AR]\t  "$@ $<
	@$(AR) cr $@ $<

# single file application building rule
# ----
#
# Note: "%:%.o" and "%:c" disables the corresponding implicit rules
%:	%.c
%:	%.o
%:	%.o  $(LIBS_DEP)
	@echo -e "  [LINK]\t  "$@
	@$(CC) $(CPPFLAGS) $(CFLAGS) -o $@ $< $(LDFLAGS) $(LIBS)

# compiling rule
# ----
#
# Note: "%.o:%.c" disables the implicit rule which does not
# chain the rule %.d
#
%.o:	%.c
%.o:	%.c %.d
	@echo -e "  [CC]\t  "$@
	@$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

# dependency generation rule
# ----
%.d:	%.c
	@echo -e "  [DEP]\t  "$@
	@set -e; rm -f $@; \
	$(CC) -MM $(CPPFLAGS) $< | \
	sed 's,:,: $(MAKE_CONF) $(BUILD_CFG),' | \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@;

# cleaning rule
# ----
clean:
	@rm -vf $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.o,$(wildcard $(D)/*.c))))
	@rm -vf $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.d,$(wildcard $(D)/*.c))))
	@rm -vf $(foreach M,$(EMODULES),libnm$(M).a)
	@rm -vf $(APP) $(patsubst %,%.o,$(APP)) $(patsubst %,%.d,$(APP))

#/////////////////////////////////////////////////////////////////////////////#
endif

# echo rules
# ----
echo_CPPFLAGS:
	@echo $(CPPFLAGS)

echo_CFLAGS:
	@echo $(CFLAGS)

echo_LDFLAGS:
	@echo $(LDFLAGS)	

echo_LIBS:
	@echo $(LIBS)

echo_LIBS_DEP:
	@echo $(LIBS_DEP)

echo_NM_PREFIX:
	@echo $(NM_PREFIX)


# disabling of automatic intermediate file deletion
# ----
.SECONDARY: $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.o,$(wildcard $(D)/*.c))))

.SECONDARY: $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.d,$(wildcard $(D)/*.c))))

# include the dependency files
# ====
-include $(APP:%=%.d) $(foreach M,$(EMODULES),$(foreach D,$(NM_$(M)_PATH)/src $(NM_$(M)_SRCPATH),$(patsubst %.c,%.o,$(wildcard $(D)/*.d))))

#====================================================================

