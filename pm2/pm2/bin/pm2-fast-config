#!/bin/sh
#
#                      PM2 HIGH-PERF/ISOMALLOC
#           High Performance Parallel Multithreaded Machine
#                           version 3.0
#
#     Gabriel Antoniu, Olivier Aumage, Luc Bouge, Vincent Danjean,
#       Christian Perez, Jean-Francois Mehaut, Raymond Namyst
#
#            Laboratoire de l'Informatique du Parallelisme
#                        UMR 5668 CNRS-INRIA
#                 Ecole Normale Superieure de Lyon
#
#                      External Contributors:
#                 Yves Denneulin (LMC - Grenoble),
#                 Benoit Planquelle (LIFL - Lille)
#
#                    1998 All Rights Reserved
#
#
#                             NOTICE
#
# Permission to use, copy, modify, and distribute this software and
# its documentation for any purpose and without fee is hereby granted
# provided that the above copyright notice appear in all copies and
# that both the copyright notice and this permission notice appear in
# supporting documentation.
#
# Neither the institutions (Ecole Normale Superieure de Lyon,
# Laboratoire de L'informatique du Parallelisme, Universite des
# Sciences et Technologies de Lille, Laboratoire d'Informatique
# Fondamentale de Lille), nor the Authors make any representations
# about the suitability of this software for any purpose. This
# software is provided ``as is'' without express or implied warranty.
#


pm2config_usage()
{
    exit_code=$1

    cat <<EOF
Usage: $_PM2CONFIG_PROGNAME [--flavor=name] [OPTION]... [MODULE]...
  If '--flavor' is not specified, then it uses fisrt \$PM2_FLAVOR, or,
  if not set, 'default'.

Generic options
  --version	output pm2 version information.
  --help	display this help and exit.

Compilation support options
  --cflags	print pre-processor and compiler flags
  --libs	print library linking information
  --libs-only-L	only print the -L/-R part of --libs
  --libs-only-l only print the -l part of --libs
  --kernel      print flags to compile the libs themselves

Directories pm2-libs was configured to
  --bindir --srcdir --libdir --objdir --depdir --asmdir --makdir
  --stampdir --builddir --includedir --scriptdir --cppdir --tmpdir

Other options
  --ext         : extension used
  --protocols   : communication libraries used
  --modules     : modules included in the flavor
  --profmods    : modules which have the 'profile' functionality enabled
  --headgenmods : modules which generate some specific header files at compile time
  --cc          : C compiler used
  --stampfile   : stampfile generated
  --loader      : loader used

Known values for MODULE are:
    ${_PM2CONFIG_MODULES}
    all : all modules included in the flavor

EOF
    if [ $1 != 0 ]; then
	echo "error in $_PROGNAME $_ARGV" 1>&2
    fi
    exit $1
}

pm2config_add_list() # var list_val
{
    eval _old_val='$'${1}
    for _val in $2 ; do
	case " $_old_val " in
	*\ $_val\ *) # Already there 
	    ;;
	*) # Added
	    _old_val="${_old_val:+$_old_val }$_val"
	    ;;
	esac
    done
    eval $1='"${_old_val}"'
}

pm2config_remove_dupplicates() # list
{
    eval _items=\"'$'$1\"

    _rev=""
    for _i in $_items ; do
	_rev="$_i $_rev"
    done

    _l=""
    for _i in $_rev ; do
	case " $_l " in
	    *\ $_i\ *) ;;
	    *) _l="${_i}${_l:+ $_l}"
	esac
    done
    eval $1=\"'$'_l\"
}

pm2config_remove_dupplicates_keep_first() # list
{
    eval _items=\"'$'$1\"

    _l=""
    for _i in $_items ; do
	case " $_l " in
	    *\ $_i\ *) ;;
	    *) _l="${_l:+$_l }$_i"
	esac
    done
    eval $1=\"'$'_l\"
}

pm2config_build_uppercase() # list
{
    _list=$*
    _LIST=`echo $_list | tr a-z A-Z`
    while [ -n "$_list" ] ; do
	set $_LIST
	_big=$1
	shift
	_LIST=$*

	set $_list
	_small=$1
	shift
	_list=$*

	eval ${_small}_to_upper=\$_big
    done
}

pm2config_init()
{
    _PM2CONFIG_FLAVOR=${PM2_FLAVOR:-default}
    export _PM2CONFIG_FLAVOR

    # Get the flavor script file path
    set --  --source-mode -f $_PM2CONFIG_FLAVOR
    . ${PM2_ROOT}/bin/pm2-flavor-file $*
    _PM2CONFIG_FLAVOR_FILE=$PM2_FLAVOR_FILE
    export _PM2CONFIG_FLAVOR_FILE

    if [ ! -f "$_PM2CONFIG_FLAVOR_FILE" ]; then
	echo "Flavor '$_PM2CONFIG_FLAVOR' do not exists yet. Create it before." 1>&2
	echo "You can use 'make init' to create the basic flavors of pm2" 1>&2
	echo "or 'make config|menuconfig|xdialogconfig|xconfig' to create your own flavor." 1>&2
	exit 1
    fi
}

pm2config_set_vars()
{
    # Initialize flavor script file name
    pm2config_init

    set -- --source-mode
    . ${PM2_ROOT}/bin/pm2_sys $*
    . ${PM2_ROOT}/bin/pm2_arch $*

    # Source the flavor script file
    set --
    . $_PM2CONFIG_FLAVOR_FILE

    # Special variable (may be used within the build directory path for instance)
    flavor=$_PM2CONFIG_FLAVOR

    # Optimizations
    pm2config_build_uppercase common $_PM2CONFIG_DIRTY_ORDERED_MODULES

    # Build directory
    if [ -z "$PM2_BUILD" ] ; then
	_PM2CONFIG_BUILD=$HOME/build/$flavor
    else
	eval _PM2CONFIG_BUILD="$PM2_BUILD"
    fi
    case "$_PM2CONFIG_BUILD" in
	/*)
	    ;;
	*)
	    eval _PM2CONFIG_BUILD="${PM2_BUILD_DIR:-$HOME/build}"'/$_PM2CONFIG_BUILD'
    esac
    export _PM2CONFIG_BUILD

    # Extension
    _PM2CONFIG_EXT="$PM2_EXT"
    export _PM2CONFIG_EXT

    # Loader
    if [ -n "${PM2_LOADER}" ]; then
	_PM2CONFIG_LOADER="$PM2_LOADER"
    elif [ -n "$PM2_DEFAULT_LOADER" ]; then
	_PM2CONFIG_LOADER="$PM2_DEFAULT_LOADER"
    else
	_PM2CONFIG_LOADER=""
    fi
    export _PM2CONFIG_LOADER

    # Flavor stamp file
    _PM2CONFIG_FLAVOR_STAMP_FILE=$_PM2CONFIG_FLAVOR_FILE
    export _PM2CONFIG_FLAVOR_STAMP_FILE

    _PM2CONFIG_LIB_STAMP_FILES=""
    export _PM2CONFIG_LIB_STAMP_FILES
    for _lib in common $PM2_LIBS ; do
	eval _LIB='$'${_lib}_to_upper
	eval _libname='$'PM2_${_LIB}_LIBNAME

	# Libs stamp files
	eval _PM2CONFIG_${_libname}_STAMP_FILE=${_PM2CONFIG_BUILD}/${_lib}/lib/lib${_libname}${PM2_EXT}.a
	eval export _PM2CONFIG_${_libname}_STAMP_FILE
	eval _PM2CONFIG_LIB_STAMP_FILES=\"'$'{_PM2CONFIG_LIB_STAMP_FILES:+$_PM2CONFIG_LIB_STAMP_FILES }'$'_PM2CONFIG_${_libname}_STAMP_FILE\"

	# Directories
	eval _PM2CONFIG_${_lib}_LIB_DIR=$_PM2CONFIG_BUILD/${_lib}/lib
	eval export _PM2CONFIG_${_lib}_LIB_DIR

	eval _PM2CONFIG_${_lib}_BIN_DIR=$_PM2CONFIG_BUILD/${_lib}/bin
	eval export _PM2CONFIG_${_lib}_BIN_DIR

	eval _PM2CONFIG_${_lib}_SRC_DIR=$_PM2CONFIG_BUILD/${_lib}/src
	eval export _PM2CONFIG_${_lib}_SRC_DIR

	eval _PM2CONFIG_${_lib}_OBJ_DIR=$_PM2CONFIG_BUILD/${_lib}/obj
	eval export _PM2CONFIG_${_lib}_OBJ_DIR

	eval _PM2CONFIG_${_lib}_CPP_DIR=$_PM2CONFIG_BUILD/${_lib}/cpp
	eval export _PM2CONFIG_${_lib}_CPP_DIR

	eval _PM2CONFIG_${_lib}_DEP_DIR=$_PM2CONFIG_BUILD/${_lib}/dep
	eval export _PM2CONFIG_${_lib}_DEP_DIR

	eval _PM2CONFIG_${_lib}_TMP_DIR=$_PM2CONFIG_BUILD/${_lib}/tmp
	eval export _PM2CONFIG_${_lib}_TMP_DIR

	eval _PM2CONFIG_${_lib}_ASM_DIR=$_PM2CONFIG_BUILD/${_lib}/asm
	eval export _PM2CONFIG_${_lib}_ASM_DIR

	eval _PM2CONFIG_${_lib}_INCLUDE_DIR=$_PM2CONFIG_BUILD/${_lib}/include${_PM2CONFIG_EXT}
	eval export _PM2CONFIG_${_lib}_INCLUDE_DIR
    done

    # Make directory
    _PM2CONFIG_MAK_DIR=$_PM2CONFIG_BUILD/mak
    export _PM2CONFIG_MAK_DIR

    # Stamp directory
    _PM2CONFIG_STAMP_DIR=$_PM2CONFIG_BUILD/stamp
    export _PM2CONFIG_STAMP_DIR

    # Modules
    _PM2CONFIG_MODULES=""
    for _l in $_PM2CONFIG_DIRTY_ORDERED_MODULES ; do
	case " $PM2_LIBS " in
	    *\ $_l\ *)
		_PM2CONFIG_MODULES="${_PM2CONFIG_MODULES:+$_PM2CONFIG_MODULES }$_l"
		;;
	esac
    done
    export _PM2CONFIG_MODULES

    # Profiled modules
    _PM2CONFIG_PROF_MODULES=""
    for _l in $_PM2CONFIG_DIRTY_ORDERED_MODULES ; do
	eval _L='$'${_l}_to_upper
	eval _CFK='$'PM2_${_L}_CFLAGS_KERNEL
	case " $_CFK " in
	    *\ -DDO_PROFILE\ *)
		case " $PM2_LIBS " in
		    *\ $_l\ *)
			_PM2CONFIG_PROF_MODULES="${_PM2CONFIG_PROF_MODULES:+$_PM2CONFIG_PROF_MODULES }$_l"
			;;
		esac
		;;
	esac
    done
    export _PM2CONFIG_PROF_MODULES

    # Modules generating headers
    _PM2CONFIG_HEADGEN_MODULES=""
    for _l in $_PM2CONFIG_DIRTY_ORDERED_MODULES ; do
	eval _L='$'${_l}_to_upper
	eval _GENINC='$'PM2_${_L}_GENERATE_INCLUDE
	if [ "$_GENINC" = true ] ; then
	    case " $PM2_LIBS " in
		*\ $_l\ *)
		    _PM2CONFIG_HEADGEN_MODULES="${_PM2CONFIG_HEADGEN_MODULES:+$_PM2CONFIG_HEADGEN_MODULES }$_l"
		    ;;
	    esac
	fi
    done
    export _PM2CONFIG_HEADGEN_MODULES

    # Protocols
    _PM2CONFIG_PROTOCOLS="$PM2_PROTOCOLS"
    export _PM2CONFIG_PROTOCOLS

    # C Compiler
    _PM2CONFIG_CC=${PM2_CC:-gcc}
    export _PM2CONFIG_CC

    # CFLAGS
    _PM2CONFIG_CFLAGS="-D${PM2_ARCH} -D${PM2_SYS} ${PM2_COMMON_CFLAGS_KERNEL}"
    for _lib in common $PM2_LIBS ; do
	eval _LIB='$'${_lib}_to_upper
	eval _flags=\"'$'PM2_${_LIB}_CFLAGS -D${_LIB}\"
	if [ -d "${PM2_ROOT}/modules/$_lib/include" ]; then
	    _flags="$_flags -I${PM2_ROOT}/modules/$_lib/include"
	fi
	eval _geninc='$'PM2_${_LIB}_GENERATE_INCLUDE
	if [ "$_geninc" = true ]; then
	    eval _flags=\"$_flags -I\$_PM2CONFIG_${_lib}_INCLUDE_DIR\"
	fi
	_PM2CONFIG_CFLAGS="$_PM2CONFIG_CFLAGS $_flags"
    done
    export _PM2CONFIG_CFLAGS
    pm2config_remove_dupplicates_keep_first _PM2CONFIG_CFLAGS

    # CFLAGS "kernel"
    for _lib in common $PM2_LIBS ; do
	eval _LIB='$'${_lib}_to_upper
	eval _PM2CONFIG_${_lib}_KERNEL_CFLAGS=\"\$_PM2CONFIG_CFLAGS '$'PM2_${_LIB}_CFLAGS_KERNEL -D${_LIB}_KERNEL -DMODULE=${_lib}\"
	eval export _PM2CONFIG_${_lib}_KERNEL_CFLAGS
	eval pm2config_remove_dupplicates_keep_first _PM2CONFIG_${_lib}_KERNEL_CFLAGS
    done

    # LDFLAGS
    _requested=""
    _extra=""
    _PM2CONFIG_LD_PATH=""
    for _lib in common $PM2_LIBS ; do
	eval _LIB='$'${_lib}_to_upper
	eval _requested=\"\$_requested \$PM2_${_LIB}_LIBNAME\"
	eval _PM2CONFIG_LD_PATH=\"\$_PM2CONFIG_LD_PATH -L\$_PM2CONFIG_${_lib}_LIB_DIR\"
	eval _extra=\"\$_extra \$PM2_${_LIB}_LIBS\"
    done
    export _PM2CONFIG_LD_PATH

    _PM2CONFIG_LD_LIBS=""
    for _lib in $_PM2CONFIG_DIRTY_ORDERED_LIBS ; do
	case " $_requested " in
	    *\ $_lib\ *)
		_PM2CONFIG_LD_LIBS="$_PM2CONFIG_LD_LIBS -l${_lib}${_PM2CONFIG_EXT}"
		;;
	    *) ;;
	esac
    done
    _PM2CONFIG_LD_LIBS="$_PM2CONFIG_LD_LIBS $_extra"
    export _PM2CONFIG_LD_LIBS

    _PM2CONFIG_LIBS="$_PM2CONFIG_LD_PATH $_PM2CONFIG_LD_LIBS"
    export _PM2CONFIG_LIBS
}

pm2config_parse_cmdline() # args
{
    _ARGV="$@"

    _PROGNAME="pm2-config"

    [ $# -ge 1 ] || pm2config_usage 1

    _cflags=false
    _libs_L=false
    _libs_l=false
    _flavor=
    _libs=

    _libdir=false
    _includedir=false
    _bindir=false
    _srcdir=false
    _objdir=false
    _cppdir=false
    _depdir=false
    _asmdir=false
    _tmpdir=false
    _stampdir=false
    _builddir=false
    _makdir=false

    _dirtoshow=
    _libs_add_mad=false
    _libs_add_all=false
    _kernel=false
    _other=false
    _gen_mak=false

    while [ $# -gt 0 ] ; do
	case "$1" in
	    -*=*) _optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
	    *) _optarg= ;;
	esac

    case $1 in
    --version)
	echo pm2-libs 3.0
	exit 0
	;;
    --help)
	pm2config_usage 0
	;;
    --kernel)
	_kernel=true
	;;
    --*dir)
	_dirname1=`echo $1 | sed -e 's,^--,,' -e 's,dir$,,'`
	eval _dirname='$'_${_dirname1}dir
	test -z "$_dirname" && exit 1
	eval ${_dirname1}dir=true
	_dirtoshow="$_dirname1"
	;;
    --ext|--protocols|--modules|--profmods|--headgenmods|--cc|--stampfile|--loader)
	_other=$1
	;;
    --cflags)
       	_cflags=true
       	;;
    --libs)
       	_libs_L=true
	_libs_l=true
       	;;
    --libs-only-L)
	_libs_L=true
	;;
    --libs-only-l)
	_libs_l=true
	;;
    --flavor=*)
	PM2_FLAVOR=$_optarg
	;;
    -*)
	echo Unknown option \`$1\' 1>&2
	pm2config_usage 1
	;;
    all)
	_libs_add_all=true
	;;
    *)
	_PM2CONFIG_ALL_MODULES=`${PM2_ROOT}/bin/pm2-module modules`

	if [ -z "$_PM2CONFIG_ALL_MODULES" ]; then
	    echo "No PM2 module detected." 1>&2
	    echo "Please check your PM2_ROOT environment variable and/or do 'make init'" 1>&2
	    exit 1
	fi

	case " $_PM2CONFIG_ALL_MODULES common " in
	*\ $1\ *)
	    pm2config_add_list _libs "$1"
	    ;;
	*)
	    echo Unknown library \`$1\' 1>&2
	    ;;
	esac
	;;
    esac
    shift
    done    

    ##########################################################################

    pm2config_set_vars

    ##########################################################################

    if [ "$_libs_add_all" = true ]; then
	pm2config_add_list _libs "common $PM2_LIBS"
    fi

    if [ "$_other" != false ]; then
	_dirtoshow=$_other
    fi

    # on a demandé des repertoires/réglages...
    if [ -n "${_dirtoshow}" ]; then
	case $_dirtoshow in
	    --ext)
		echo $_PM2CONFIG_EXT
		exit 0
		;;
	    --protocols)
		echo $_PM2CONFIG_PROTOCOLS
		exit 0
		;;
	    --modules)
		echo $_PM2CONFIG_MODULES
		exit 0
		;;
	    --profmods)
		echo $_PM2CONFIG_PROF_MODULES
		exit 0
		;;
	    --headgenmods)
		echo $_PM2CONFIG_HEADGEN_MODULES
		exit 0
		;;
	    --cc)
		echo $_PM2CONFIG_CC
		exit 0
		;;
	    --loader)
		echo $_PM2CONFIG_LOADER
		exit 0
		;;
	    --stampfile)
		if [ -z "$_libs" ]; then
		    echo $_PM2CONFIG_FLAVOR_STAMP_FILE
		elif [ "$_libs_add_all" = "true" ] ; then
		    echo $_PM2CONFIG_LIB_STAMP_FILES
		else
		    for _lib in $_libs; do
			_LIB=`echo $_lib | tr 'a-z' 'A-Z'`
			eval _libname=\$PM2_${_LIB}_LIBNAME
			eval echo \$_PM2CONFIG_${_libname}_STAMP_FILE
		    done
		fi
		exit 0
		;;
	    build)
		echo $_PM2CONFIG_BUILD
		exit 0
		;;
	    stamp)
		echo $_PM2CONFIG_STAMP_DIR
		exit 0
		;;
	    mak)
		echo $_PM2CONFIG_MAK_DIR
		exit 0
		;;
	esac
	if [ `echo "$_libs" | wc -w` != 1 ]; then
	    echo "This option needs exactly ONE lib" 1>&2
	    exit 1
	fi
	case " $PM2_LIBS common " in
	    *\ $_libs\ *)
		_d=`echo $_dirtoshow | tr a-z A-Z`
		eval echo \$_PM2CONFIG_${_libs}_${_d}_DIR
		;;
	    *)
		;;
	esac
	exit 0
    fi

    if [ -z "$_libs" ]; then
	_libs="common $PM2_LIBS"
    fi

    # On a demandé les CFLAGS
    if [ "$_cflags" = true ] ; then
	if [ "$_kernel" = true ] ; then
	    if [ `echo "$_libs" | wc -w` != 1 ]; then
		echo "This option needs exactly ONE lib" 1>&2
		exit 1
	    fi
	    eval echo \$_PM2CONFIG_${_libs}_KERNEL_CFLAGS
	else
	    echo $_PM2CONFIG_CFLAGS
	fi
	exit 0
    fi

    # on a demandé les LDFLAGS
    _libs=""
    if [ "$_libs_L" = true ] ; then
	_libs="$_PM2CONFIG_LD_PATH"
    fi
    if [ "$_libs_l" = true ]; then
	_libs="$_libs $_PM2CONFIG_LD_LIBS"
    fi
    echo $_libs
    exit 0
}

######################
# Programme principal
######################

_PM2CONFIG_DIRTY_ORDERED_MODULES="profile leoparse pm2 dsm mad1 mad2 marcel tbx ntbx pm2debug"

_PM2CONFIG_DIRTY_ORDERED_LIBS="common leoparse pm2 dsm mad marcel tbx ntbx profile pm2debug"

if [ $# -eq 1 -a "$1" = --source-mode ] ; then
    pm2config_set_vars
else
    pm2config_parse_cmdline "$@"
    exit 0
fi

