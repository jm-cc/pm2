#! /bin/bash

# PM2: Parallel Multithreaded Machine
# Copyright (C) 2006 "the PM2 team" (see AUTHORS file)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

export PATH="@abs_top_builddir@/bin:$PATH"
export PM2_ROOT="@abs_top_srcdir@"
export PM2_SRCROOT="@abs_top_srcdir@"
export PM2_OBJROOT="@abs_top_builddir@"

usage() {
    cat <<EOF
mpirun [<mpirun_option>...] <progname> [<option>...]

  <mpirun_option>:
    -h      This help
    -machinefile <file>
            Take the list of possible machines to run on from the
            file <file>.  This is a list of all available machines;
            use -np <np> to request a specific number of machines.
    -np|-n <n>
            specify the number of processors to run on
    -v      Verbose - throw in some comments
    -debug  Start processes under the gdb debugger.
    -valgrind
            Start processes under valgrind.
    -x
            Starts each processus in a graphical console
    -protocol <name>
            Uses the specified network protocol to start the application

On exit, mpirun returns a status of zero unless mpirun detected a problem, in
which case it returns a non-zero status.

Environment variables:
   - NMAD_DRIVER specifies the network driver to use. By default, the 
     driver selected by nmad-driver-conf is used.
   - NMAD_STRATEGY specifies the scheduler strategy to be used. By
     default, the strategy selected with nmad-strategy-conf is used.
EOF
}

# backward compatibility with old leonie-based mpirun for Mad-MPI
if [ "x${MPI_NMAD_PROTOCOL}" != "x" ]; then
    NMAD_DRIVER="${MPI_NMAD_PROTOCOL}"
fi
if [ "x${MPI_NMAD_STRATEGY}" != "x" ]; then
    NMAD_STRATEGY="${MPI_NMAD_STRATEGY}"
fi

# generate -D for driver and strategy
if [ "x${NMAD_DRIVER}" != "x" ]; then
    args="${args} -DNMAD_DRIVER=${NMAD_DRIVER}"
fi
if [ "x${NMAD_STRATEGY}" != "x" ]; then
    args="${args} -DNMAD_STRATEGY=${NMAD_STRATEGY}"
fi

if [ $# = 0 ]; then
    usage
    exit 1;
elif [ $# = 1 ]; then
    case "$1" in
	-h|-help|--help)
	    usage
	    exit 0
	    ;;
    esac
fi

exec ${PM2_OBJROOT}/bin/pm2-load ${args} "$@"

