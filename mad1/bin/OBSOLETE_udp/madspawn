#!/bin/sh

# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (see AUTHORS file)
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


#
# madspawn attend les paramètres suivants :
# $1 : machine serveur
# $2 : confsize
# $3 à $(confsize+1) : ports serveurs...
# $(confsize+2) à ... : executable a lancer et arguments
#

serverhost=$1
shift
confsize=$1
n=$1
shift

ports=$1
shift
while test $n -gt 2
do
    ports="$ports $1"
    shift
    n=`expr $n - 1`
done

command=$*

set $ports

mynumber=1
nbmachines=`cat ${MADELEINE_ROOT}/.madconf | wc -w`

if test -z "$MAD_DEBUG"
then
    MAD_DEBUG=off
fi

if test -z "$DISPLAY"
then
    DISPLAY=:0
fi

while test $mynumber -lt $confsize
do
    plusun=`expr $mynumber % $nbmachines + 1`
    host=`head -$plusun ${MADELEINE_ROOT}/.madconf | tail -1`
    rsh -n $host ${MADELEINE_ROOT}/bin/udp/madstart $DISPLAY $MAD_DEBUG $confsize $mynumber $host $1 $serverhost $command &
    mynumber=`expr $mynumber + 1`
    shift
done



