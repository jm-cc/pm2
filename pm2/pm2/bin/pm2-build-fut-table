#!/bin/sh

# PM2: Parallel Multithreaded Machine
# Copyright (C) 2001 "the PM2 team" (see AUTHORS file)
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.


error() # msg
{
    echo $*
    exit 1
}

usage() # exit_code
{
    cat <<EOF
Usage: $PROGNAME { option }

  option:
    -f name : Use flavor named "name" (default=\$PM2_FLAVOR or default)
    -h : Display this help message
EOF
    exit $1
}

PM2_FLAVOR=${PM2_FLAVOR:-default}
export PM2_FLAVOR

while [ $# -gt 0 ]; do
    case $1 in
	-f)
	    shift
	    PM2_FLAVOR="$1"
	    shift
	    ;;
	-h)
	    usage 0
	    ;;
	--)
	    shift
	    break
	    ;;
	*)
	    break
	    ;;
    esac
done

#echo "Building fut_entries.h & fut_print.h for flavor $PM2_FLAVOR..."

set -- --source-mode
. ${PM2_ROOT}/bin/pm2-config

BUILDDIR=$_PM2CONFIG_BUILD

if echo $_PM2CONFIG_CFLAGS | egrep 'MARCEL_.*(SMP|NUMA)' > /dev/null; then
    # Mode SMP : les enregistrements comportent un paramètre supplémentaire...
    RECORD_SIZE=16
else
    RECORD_SIZE=12
fi

GENDIR=${BUILDDIR}/profile/include

if [ ! -d ${GENDIR} ] ; then
    mkdir -p ${GENDIR}
fi

deffile=${GENDIR}/fut_entries.h
echo "#ifndef FUT_ENTRIES_IS_DEF" > $deffile
echo "#define FUT_ENTRIES_IS_DEF" >> $deffile
echo >> $deffile

printfile=${GENDIR}/fut_print.h
> $printfile

for c in \
    FUT_SETUP_CODE \
    FUT_KEYCHANGE_CODE \
    FUT_RESET_CODE \
    FUT_CALIBRATE0_CODE \
    FUT_CALIBRATE1_CODE \
    FUT_CALIBRATE2_CODE \
    FUT_SWITCH_TO_CODE \
    FUT_NEW_LWP_CODE \
    FUT_THREAD_BIRTH_CODE \
    FUT_THREAD_DEATH_CODE \
    FUT_SET_THREAD_NAME_CODE \
    FUT_MAIN_ENTRY_CODE \
    FUT_MAIN_EXIT_CODE
    do
    code="`grep $c ${PM2_ROOT}/profile/include/fut.h | sed -e 's/#define[ \t]*[_A-Za-z0-9]*.*\(0x[0-9A-Fa-f]*\)/\1/'`"
    label="`echo $c | sed -e 's/^\(FUT_.*\)_CODE$/\1/' | tr A-Z a-z`"
    echo "{ $code, \"$label\" }," >> $printfile
done

base=`expr 4096 + 256` # 0x1100
value=0
other=15728640 # 0xf00000

THE_MODULES="$_PM2CONFIG_PROF_MODULES"
case " $_PM2CONFIG_CFLAGS " in
    *\ -DAPPLI_PROFILE\ *)
	THE_MODULES="${THE_MODULES} examples"
	;;
esac

for mod in $THE_MODULES ; do

    # Ugly!!! We should use --cppdir <mod> instead of --buildir!
    FUT_FILES=`find ${BUILDDIR}/$mod -name '*.fut'`
    if [ -z "$FUT_FILES" ] ; then
	continue
    fi
    for e in `cat $FUT_FILES | sort | uniq`; do
    case $e in
        *entry_code)
	    num=`expr $value + $base`

	    echo "{ `printf "0x%x" $num`, \"`echo $e | sed -e 's/fut_\(.*\)_entry_code/\1_entry/'`\" }," >> $printfile

	    # The following generates the right shifted code
	    num=`expr $num \* 256 + $RECORD_SIZE`
	    num=`printf "0x%x" $num`
            echo "unsigned $e = $num ;" >> $deffile
            ;;
        *exit_code)
	    num=`expr $value + $base + 256`

	    echo "{ `printf "0x%x" $num`, \"`echo $e | sed -e 's/fut_\(.*\)_exit_code/\1_exit/'`\" }," >> $printfile

	    # The following generates the right shifted code
	    num=`expr $num \* 256 + $RECORD_SIZE`
	    num=`printf "0x%x" $num`
            echo "unsigned $e = $num ;" >> $deffile

            value=`expr $value + 1`
	    if [ $value = 256 ]; then
		base=`expr $base + 512`
		value=0
	    fi
	    ;;
        *single_code)

	    echo "{ `printf "0x%x" $other`, \"`echo $e | sed -e 's/fut_\(.*\)_single_code/\1/'`\" }," >> $printfile

	    # The following generates the right shifted code
	    num=`expr $other \* 256 + $RECORD_SIZE`
	    num=`printf "0x%x" $num`
            echo "unsigned $e = $num ;" >> $deffile

	    other=`expr $other + 1`
            ;;
        *single_code1)

	    echo "{ `printf "0x%x" $other`, \"`echo $e | sed -e 's/fut_\(.*\)_single_code/\1/'`\" }," >> $printfile

	    # The following generates the right shifted code
	    num=`expr $other \* 256 + $RECORD_SIZE + 4`
	    num=`printf "0x%x" $num`
            echo "unsigned $e = $num ;" >> $deffile

	    other=`expr $other + 1`
            ;;
        *single_code2)

	    echo "{ `printf "0x%x" $other`, \"`echo $e | sed -e 's/fut_\(.*\)_single_code/\1/'`\" }," >> $printfile

	    # The following generates the right shifted code
	    num=`expr $other \* 256 + $RECORD_SIZE + 8`
	    num=`printf "0x%x" $num`
            echo "unsigned $e = $num ;" >> $deffile

	    other=`expr $other + 1`
            ;;
	*)
	    echo "FATAL ERROR!";
	    exit 1
	    ;;
    esac
    done
done
echo >> $deffile
echo "#endif" >> $deffile

exit 0
