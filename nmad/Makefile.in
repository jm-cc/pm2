# autoconf-based makefile for nmad

srcdir := @srcdir@
VPATH  := $(srcdir)

include @abs_top_builddir@/common_vars.mk

TARGET_BIN =
TARGET_LIB = libnmad.so

INSTALL_BIN       = $(TARGET_BIN)
INSTALL_LIB       = $(TARGET_LIB)
INSTALL_INCLUDE  += $(wildcard $(srcdir)/include/*.h) $(wildcard @nmad_builddir@/include/*.h)
INSTALL_PKGCONFIG = nmad.pc

INSTALL_INCLUDE_PATH := $(INSTALL_PREFIX)/include

TARGETS = $(TARGET_BIN) $(TARGET_LIB) subdirs

# ## dirs with their own Makefile- build as subdirs
DIRS_WITHMK := $(patsubst %/Makefile, %, $(foreach d, @nmad_alldirs@, $(wildcard $(d)/Makefile)))
SUBDIRS     += $(DIRS_WITHMK)

# ## dirs without separate makefile- include in libnmad
DIRS_NOMK  := $(filter-out $(DIRS_WITHMK), @nmad_alldirs@)
SRC_FILES  := $(foreach d, src $(DIRS_NOMK), $(wildcard $(srcdir)/$(d)/*.c) $(wildcard $(srcdir)/$(d)/src/*.c))
OBJ_FILES  := $(patsubst $(srcdir)/%.c, ./%.pic.o, $(SRC_FILES))
DEP_FILES  := $(patsubst $(srcdir)/%.c, ./%.d, $(SRC_FILES))
CLEAN_MORE += $(OBJ_FILES) $(DEP_FILES)
TARGET_DEP += $(DEP_FILES)
INSTALL_INCLUDE += $(foreach d, $(DIRS_NOMK), $(wildcard $(srcdir)/$(d)/include/*.h))

# set compilers and flags
CFLAGS  := @NMAD_CORE_CFLAGS@
LDFLAGS := @NMAD_CORE_LDFLAGS@
LIBS    := @NMAD_CORE_LIBS@

TARGET_CLEAN += clean-examples

include @abs_top_builddir@/common_rules.mk

-include $(DEP_FILES)

libnmad.so: $(OBJ_FILES)

ifneq ($(MAKECMDGOALS),clean)
$(SUBDIRS): | $(TARGET_LIB)
endif

# ## Examples, tests, bench

.PHONY: examples check tests bench eztrace

eztrace: eztrace-gen | eztrace-build

eztrace-gen:
	$(Q)eztrace_create_plugin -o eztrace_nmad_core -I $(srcdir)/include -I @nmad_builddir@/include ./nmad-eztrace.tpl

eztrace-build:
	$(Q)$(MAKE) -C eztrace_nmad_core CC=$(CC) CFLAGS="$(CFLAGS)"

examples:
	$(Q)$(MAKE) install
	$(Q)$(MAKE) -C examples install

clean-examples:
	$(Q)$(MAKE) -C examples clean

check: tests

tests:
	$(Q)$(MAKE) install
	$(Q)$(MAKE) -C examples tests

bench:
	$(Q)$(MAKE) install
	$(Q)$(MAKE) -C examples bench

# ## Doxygen
#
docs: doxygen

doxygen: $(SRC_FILES)

upload-doc: doxygen
	rsync -avz @nmad_builddir@/doc/html/ scm.gforge.inria.fr:/home/groups/pm2/htdocs/newmadeleine/doc/

