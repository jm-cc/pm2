#!/bin/sh
#
#                      PM2 HIGH-PERF/ISOMALLOC
#           High Performance Parallel Multithreaded Machine
#                           version 3.0
#
#     Gabriel Antoniu, Olivier Aumage, Luc Bouge, Vincent Danjean,
#       Christian Perez, Jean-Francois Mehaut, Raymond Namyst
#
#            Laboratoire de l'Informatique du Parallelisme
#                        UMR 5668 CNRS-INRIA
#                 Ecole Normale Superieure de Lyon
#
#                      External Contributors:
#                 Yves Denneulin (LMC - Grenoble),
#                 Benoit Planquelle (LIFL - Lille)
#
#                    1998 All Rights Reserved
#
#
#                             NOTICE
#
# Permission to use, copy, modify, and distribute this software and
# its documentation for any purpose and without fee is hereby granted
# provided that the above copyright notice appear in all copies and
# that both the copyright notice and this permission notice appear in
# supporting documentation.
#
# Neither the institutions (Ecole Normale Superieure de Lyon,
# Laboratoire de L'informatique du Parallelisme, Universite des
# Sciences et Technologies de Lille, Laboratoire d'Informatique
# Fondamentale de Lille), nor the Authors make any representations
# about the suitability of this software for any purpose. This
# software is provided ``as is'' without express or implied warranty.
#

PM2_CONFIG=${PM2_ROOT}/flavors
PM2_SYS=`${PM2_ROOT}/bin/pm2_sys`
PM2_ARCH=`${PM2_ROOT}/bin/pm2_arch`

ARGV="$@"

PROGNAME="pm2-config"

MODULES=`${PM2_ROOT}/bin/pm2-module modules`

if [ -z "$MODULES" ]; then
    echo "No PM2 module detected." 1>&2
    echo "Check PM2_ROOT environment variable and/or do 'make init'" 1>&2
    exit 1
fi

##########################################################################
# aide
usage()
{
    exit_code=$1

    cat <<EOF
Usage: $PROGNAME [--flavor=name] [OPTION]... [MODULE]...
  If '--flavor' is not specified, then it uses fisrt \$PM2_FLAVOR, or,
  if not set, 'default'.

Generic options
  --version	output pm2 version information.
  --help	display this help and exit.

Compilation support options
  --cflags	print pre-processor and compiler flags
  --libs	print library linking information
  --libs-only-L	only print the -L/-R part of --libs
  --libs-only-l only print the -l part of --libs
  --kernel      print flags to compile the libs themselves

Directories pm2-libs was configured to
  --bindir --srcdir --libdir --objdir --depdir --asmdir --stampdir --builddir --includedir

Other options
  --ext       : extension used
  --protocols : communication libraries used
  --modules   : modules included in the flavor
  --cc        : C compiler used
  --stampfile : stampfile generated

Known values for MODULE are:
    ${MODULES}
    all : all modules included in the flavor

EOF
    if [ $exit_code != 0 ]; then
	echo "error in pm2-config $ARGV" 1>&2
    fi
    exit $exit_code
}

##########################################################################
# fonctions annexes

#. ${PM2_ROOT}/bin/pm2_mad2config
#. ${PM2_ROOT}/bin/pm2_mad1config

get_lib_dir() # library
{
    BASEDIR=`(cd "$PM2_ROOT/modules/$1"; pwd)`
    echo "$BASEDIR/build/${PM2_BUILD:+$PM2_BUILD/}lib"
}

get_include_dir() # library
{
    BASEDIR=`(cd "$PM2_ROOT/modules/$1"; pwd)`
    echo "$BASEDIR/build/${PM2_BUILD:+$PM2_BUILD/}include${PM2_EXT}"
}

add_list() { # var list_val
    old_val=`eval echo '$'${1}`
    for val in $2 " "; do
	case " $old_val   " in
	*\ $val\ *) # Already there 
	    ;;
	*) # Added
	    old_val="${old_val:+$old_val }$val"
	    ;;
	esac
    done
    eval $1='"${old_val}"'
}

##########################################################################
# traitement des options

if test $# -eq 0; then
    usage 1
fi

cflags=false
libs_L=false
libs_l=false
#modversion=false
flavor=
libs=
libdir=false
includedir=false
bindir=false
srcdir=false
objdir=false
depdir=false
asmdir=false
stampdir=false
builddir=false
dirtoshow=
libs_add_mad=false
libs_add_all=false
kernel=false
other=false

while test $# -gt 0; do
    case "$1" in
    -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
    *) optarg= ;;
    esac

    case $1 in
    --version)
	echo pm2-libs 3.0
	exit 0
	;;
    --help)
	usage 0
	;;
    --kernel)
	kernel=true
	;;
    --*dir)
	dirname1=`echo $1 | sed -e 's,^--,,' -e 's,dir$,,'`
	dirname=`eval echo '$'${dirname1}dir`
	test -z "$dirname" && exit 1
	eval ${dirname}dir=true
	dirtoshow="$dirname1"
	;;
    --ext|--protocols|--modules|--cc|--stampfile)
	other=$1
	;;
    --help)
	usage 0
	;;
    --cflags)
       	cflags=true
       	;;
    --libs)
       	libs_L=true
	libs_l=true
       	;;
    --libs-only-L)
	libs_L=true
	;;
    --libs-only-l)
	libs_l=true
	;;
    --flavor=*)
	flavor=$optarg
	;;
    -*)
	echo Unknown option \`$1\' 1>&2
	usage 1
	;;
    all)
	libs_add_all=true
	;;
    *)
	case " $MODULES " in
	*\ $1\ *)
	    add_list libs "$1"
	    ;;
	*)
	    echo Unknown library \`$1\' 1>&2
	    ;;
	esac
	;;
    esac
    shift
done

##########################################################################
# corrections et valeurs par défaut
if [ -z "$flavor" ]; then
    flavor=${PM2_FLAVOR:-default}
fi

if [ ! -f $PM2_CONFIG/$flavor ]; then
    echo "Flavor $flavor do not exists yet. Create it before." 1>&2
    exit 1
fi

. $PM2_CONFIG/$flavor

if [ $libs_add_all = true ]; then
    add_list libs "$PM2_LIBS"
fi

if [ "$other" != false ]; then
    dirtoshow=$other
fi

##########################################################################
# on a demandé des repertoires/réglages...
if [ ! -z "${dirtoshow}" ]; then
    case $dirtoshow in
    --ext)
	echo $PM2_EXT
	exit 0
	;;
    --protocols)
	echo $PM2_PROTOCOLS
	exit 0
	;;
    --modules)
	case " $PM2_LIBS " in
	*\ dsm\ *)
	    echo dsm `echo $PM2_LIBS | sed -e 's,dsm,,'`
	    ;;
	*)
	    echo $PM2_LIBS
	    ;;
	esac
	exit 0
	;;
    --cc)
	echo ${PM2_CC:-gcc}
	exit 0
	;;
    --stampfile)
	if [ -z "$libs" ]; then
	    echo "$PM2_ROOT/stamp${PM2_BUILD:+/$PM2_BUILD}/stamp${PM2_EXT}"
	else
	    list=
	    for lib in $libs; do
		list="${list:+$list }$PM2_ROOT/stamp${PM2_BUILD:+/$PM2_BUILD}/libstamp-${lib}${PM2_EXT}"
	    done
	    echo $list
	fi
	exit 0
	;;
    build)
	echo $PM2_BUILD
	exit 0
	;;
    stamp)
	echo "$PM2_ROOT/stamp${PM2_BUILD:+/$PM2_BUILD}"
	exit 0
	;;
    esac
    if [ `echo "$libs" | wc -w` != 1 ]; then
	echo "This option need ONE lib" 1>&2
	exit 1
    fi
    case " $PM2_LIBS " in
    *\ $libs\ *)
	case $dirtoshow in
	include)
	    echo build/${PM2_BUILD:+$PM2_BUILD/}$dirtoshow${PM2_EXT}
	    ;;
	*)
	    echo build/${PM2_BUILD:+$PM2_BUILD/}$dirtoshow
	    ;;
	esac
	;;
    *)
	;;
    esac
    exit 0
fi

if [ -z "$libs" ]; then
    libs="$PM2_LIBS"
fi

##########################################################################
# CFLAGS et LDFLAGS...
the_flags="-D${PM2_ARCH} -D${PM2_SYS} $PM2_COMMON_CFLAGS_KERNEL $PM2_COMMON_LIBS"
if [ -d "$PM2_ROOT/modules/common/include" ]; then
    the_flags="$the_flags -I$PM2_ROOT/modules/common/include"
fi

# CFLAGS : on prend tous les cflags
for lib in $PM2_LIBS; do
    LIB=`echo $lib | tr '[a-z]' '[A-Z]'`
    the_flags="$the_flags `eval echo '$'PM2_${LIB}_CFLAGS` -D${LIB}"
    if [ -d "$PM2_ROOT/modules/$lib/include" ]; then
	the_flags="$the_flags -I$PM2_ROOT/modules/$lib/include"
    fi
    if [ "`eval echo \\$PM2_${LIB}_GENERATE_INCLUDE`" = true ]; then
	the_flags="$the_flags -I`get_include_dir $lib`"
    fi
done

vide=
libs_pm2=
# LDFLAGS : on ne prend que les lib demandées (toutes si aucune spécifiée)
for lib in $libs; do
    LIB=`echo $lib | tr '[a-z]' '[A-Z]'`
    libname="`eval echo \\$PM2_${LIB}_LIBNAME`"
    case "$libname" in
    $vide)
	;;
    *)
	the_libs="$the_libs -L`get_lib_dir $lib`"
	libs_pm2="$libs_pm2 ${libname}"
#	for l in `eval echo \\$PM2_${LIB}_MODULE_DEPEND_LIB`; do
#	    case " $libs " in
#		*\ $l\ *)
#		    LIB2=`echo $l | tr [a-z] [A-Z]`
#		    libname2="`eval echo \\$PM2_${LIB2}_LIBNAME`"
#		    the_libs="$the_libs -l${libname2}$PM2_EXT"
#		    ;;
#		*)
#		    ;;
#	    esac
#	done
	;;
    esac
    the_libs="$the_libs `eval echo '$'PM2_${LIB}_LIBS`"
    # CFLAGS spécifique à la compilation d'une lib
    if [ "$kernel" = true ]; then
	the_flags="$the_flags `eval echo '$'PM2_${LIB}_CFLAGS_KERNEL` -D${LIB}_KERNEL -DMODULE=${LIB}"
    fi
done

libs_pm2_ordered=
#ordering pm2libs hardcoded :-(
for l in pm2 dsm mad marcel tbx ntbx pm2debug; do
    case " $libs_pm2 " in
    *\ $l\ *)
	libs_pm2_ordered="$libs_pm2_ordered -l${l}$PM2_EXT"
	;;
    esac
done
for l in $libs_pm2; do
    case " $libs_pm2_ordered " in
    *\ -l${l}$PM2_EXT\ *)
	;;
    *)
	libs_pm2_ordered="$libs_pm2_ordered -l${l}$PM2_EXT"
	;;
    esac
done

the_libs="$libs_pm2_ordered $the_libs"

if $cflags; then
    all_flags="$the_flags"
fi

if $libs_L || $libs_l; then
    all_flags="$all_flags $the_libs"
fi

if test -z "$all_flags" || test "x$all_flags" = "x "; then
    exit 1
fi

# Straight out any possible duplicates, but be careful to
# get `-lfoo -lbar -lbaz' for `-lfoo -lbaz -lbar -lbaz'
other_flags=
lib_L_flags=
rev_libs=
for i in $all_flags; do
    case "$i" in
    # a library, save it for later, in reverse order
    -l*) rev_libs="$i $rev_libs" ;;
    -L*|-R*)
	if $libs_L; then
	    case " $lib_L_flags " in
	    *\ $i\ *) ;;			# already there
	    *) lib_L_flags="$lib_L_flags $i" ;;	# add it to output
	    esac 
	fi;;
    *)
	case " $other_flags " in
	*\ $i\ *) ;;				# already there
	*) other_flags="$other_flags $i" ;;	# add it to output
        esac ;;
    esac
done

ord_libs=
if $libs_l; then
    for i in $rev_libs; do
	case " $ord_libs " in
	*\ $i\ *) ;;			# already there
	*) ord_libs="$i $ord_libs" ;;	# add it to output in reverse order
	esac
    done
fi

echo $other_flags $lib_L_flags $ord_libs

exit 0
