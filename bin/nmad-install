#!/bin/sh
#########

echo "Installing NewMadeleine in directory '$1'"

# Detect networks
MX_DIR=${MX_DIR:-/opt/mx}
QSNET_DIR="/opt/qsnet"
networks="mx:$MX_DIR quadrics:$QSNET_DIR"
enabled_networks=""
for network in  $networks ; do
    network_name=$(echo $network | awk -F':' '{print $1}')
    network_dir=$(echo $network | awk -F':' '{print $2}')
    if [ -d $network_dir ] ; then
        echo -n "Do you wish to enable $network_name [Y/n]? "
        read answer

        if [ "$answer" == "Y" ] || [ "$answer" == "y" ] || [ "$answer" == "" ] ; then
            enabled_networks=$(echo "$enabled_networks:$network_name")
        fi
    fi
done

./bin/pm2-install.pl -f nmad-distrib -d "$1" -n $enabled_networks
if [ $? != 0 ] ; then
    exit
fi

echo "compiling Leonie (bootstrap code)"
rm -rf /tmp/leonie && ./bin/pm2-install.pl -f leonie -d /tmp/leonie > /tmp/leonie.out 2>&1
if [ ! -f $(pm2-config --flavor=leonie --builddir)/leonie/bin/leonie ] ; then
    echo "Compilation of leonie failed. Check /tmp/leonie.out"
    exit
fi
cp -v $(pm2-config --flavor=leonie --builddir)/leonie/bin/leonie $1/bin
cp -v ./bin/nmad-install-aux/nmad-load $1/bin
cp -v ./bin/nmad-install-aux/leo-load $1/bin
cp -v ./bin/nmad-install-aux/pm2-wrapper $1/bin

mkdir -v "$1/examples"
for f in examples/sched_opt/helper.h examples/sched_opt/sr_star.c examples/mpi/basics/star.c ; do
    cp -v nmad/$f "$1/examples"
done

echo "generating $1/examples/Makefile"
echo "include $1/mak/pm2.mak" > "$1/examples/Makefile"
cat >> "$1/examples/Makefile" <<END_MAK 

CFLAGS  += \$(PM2_CFLAGS)
LDFLAGS += \$(PM2_LDFLAGS)
LDLIBS  += \$(PM2_LDLIBS)

.PHONY: all clean

all:    sr_star star

clean:
	rm -f sr_star star
END_MAK

echo "generating $1/examples/load"
echo "#!/bin/sh

if [ \""'$1'"\" == \"\" ] ; then
  echo \"Error. load <program> [<network protocol>]\"
else
  protocol="'${2:-tcp}'"
  export PATH=$1/bin:\$PATH
  $1/bin/nmad-load -f nmad-distrib --hosts localhost:localhost --protocol "'$protocol'" \$PWD/"'$1'"
fi
" > $1/examples/load

chmod +x $1/examples/load
