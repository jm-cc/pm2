#!/bin/sh
#
#                      PM2 HIGH-PERF/ISOMALLOC
#           High Performance Parallel Multithreaded Machine
#                           version 3.0
#
#     Gabriel Antoniu, Olivier Aumage, Luc Bouge, Vincent Danjean,
#       Christian Perez, Jean-Francois Mehaut, Raymond Namyst
#
#            Laboratoire de l'Informatique du Parallelisme
#                        UMR 5668 CNRS-INRIA
#                 Ecole Normale Superieure de Lyon
#
#                      External Contributors:
#                 Yves Denneulin (LMC - Grenoble),
#                 Benoit Planquelle (LIFL - Lille)
#
#                    1998 All Rights Reserved
#
#
#                             NOTICE
#
# Permission to use, copy, modify, and distribute this software and
# its documentation for any purpose and without fee is hereby granted
# provided that the above copyright notice appear in all copies and
# that both the copyright notice and this permission notice appear in
# supporting documentation.
#
# Neither the institutions (Ecole Normale Superieure de Lyon,
# Laboratoire de L'informatique du Parallelisme, Universite des
# Sciences et Technologies de Lille, Laboratoire d'Informatique
# Fondamentale de Lille), nor the Authors make any representations
# about the suitability of this software for any purpose. This
# software is provided ``as is'' without express or implied warranty.
#

PM2_CONFIG=${PM2_ROOT}/flavors
PM2_SYS=`${PM2_ROOT}/bin/pm2_sys`
PM2_ARCH=`${PM2_ROOT}/bin/pm2_arch`

ARGV="$@"

##########################################################################
# aide
usage()
{
    exit_code=$1

    cat <<EOF
Usage: pm2_create-flavor --interactive | --flavor=name [OPTION]...

Generic options
  --version	output pm2 version information.
  --help	display this help and exit.

Options [with default value]
  --delete        to remove a flavor

  --all=""        options for all modules and applications (as if you
		    put the option(s) in all the other option selectors)
  --pm2=""        options for pm2
  --marcel="mono" options for marcel
  --mad=""        options for madeleine
  --dsm=""        options for dsm
  --common=""     common options
  --modules=""    modules to include (pm2, marcel, mad1, mad2, dsm, tbx, ntbx)
  --builddir="\$name" directory used for building
  --ext=""        extension to use

EOF
    if [ $exit_code != 0 ]; then
	echo "error in pm2_make-flavor $ARGV" 1>&2
    fi
    exit $exit_code
}

##########################################################################
##########################################################################
########################### INTERACTIVE PART #############################
##########################################################################
##########################################################################

LIST_MODULES="common marcel mad1 mad2 tbx ntbx dsm pm2"

get_value() { # needed name help
    default="`eval echo \\$$2`"
    end=false
    while [ $end = false ]; do
	echo "$3 [$default] ?"
	read rep
	if [ "$rep" = "" ]; then
	    rep="$default"
	fi
	if [ "$rep" = "_" ]; then
	    rep=""
	fi
	if [ $1 = 0 -o "$rep" ]; then
	    end=true
	fi
    done
    eval $2="$rep"
}

get_module() { # lib libname
    selected="`eval echo \\$${1}_ok`"
    if [ $selected = true ]; then
	echo "Select $2 ? [Y/n]"
	read i
	[ -z "$i" ] && i=Y
    else
	echo "Select $2 ? [y/N]"
	read i
	[ -z "$i" ] && i=N	
    fi
    case "$i" in
    Y*|y*|O*|o*)
	eval ${1}_ok=true
	;;
    *)
	eval ${1}_ok=false
	;;
    esac
}


get_modules() {
    common_ok=true
    echo "Modules selected: $modules"
    echo "correct [y/N] ?"
    read i
    [ -z "$i" ] && i=N
    case "$i" in
    Y*|y*|O*|o*)
	return 0
	;;
    esac
    while : ; do
	for mod in $LIST_MODULES; do
	    case " $modules " in
	    *\ $mod\ *)
		eval ${mod}_ok=true
		;;
	    *)
		eval ${mod}_ok=false
		;;
	    esac
	done
	echo "*******************************"
	echo "Selecting modules"
	echo
	common_ok=true
	get_module marcel "marcel library"
	get_module mad1 "madeleine 1 library"
	if [ $mad1_ok = true ]; then
	    mad2_ok=false
	    tbx_ok=false
	    ntbx_ok=false
	    mad_ok=true
	else
	    get_module mad2 "madeleine 2 library"
	    if [ $mad2_ok = true ]; then
		mad_ok=true
		tbx_ok=true
		ntbx_ok=true
		get_module tbx "toolbox library"
		get_module ntbx "net toolbox library"
	    fi
	fi
	get_module dsm "dsm library"
	if [ $mad_ok = true -a $marcel_ok = true ]; then
	    get_module pm2 "pm2 library"
	fi
	modules=
	for mod in marcel mad1 mad2 pm2 dsm tbx ntbx; do
	    if [ "`eval echo \\$${mod}_ok`" = true ]; then
		modules="${modules:+${modules} }$mod"
	    fi
	done
	if [ -z "$modules" ]; then
	    echo "You must select at least one module"
	else
	    echo "Modules selected: $modules"
	    echo "correct [Y/n] ?"
	    read i
	    [ -z "$i" ] && i=Y
	    case "$i" in
	    Y*|y*|O*|o*)
		return 0
		;;
	    esac
	fi
    done
}

help_option() {
    echo "Commands:"
    echo "add opt1 [opt2 ...]   : add the options"
    echo "sub opt1 [opt2 ...]   : remove the options" 
    echo "opt1 [opt2 ...]       : add or remove the options"
    echo "q|quit|exit           : quit"
    echo "clear                 : clear the options"
    echo "help                  : this help"
    echo "help opt              : help on option 'opt' if any"
    echo
    echo "Available options:"
    for opt in $listopt; do
	if [ -f $REP/$opt.help ]; then
	    deb="`echo $opt'                ' | cut -c-12`"                   
	    echo "$deb: `head -n 1 $REP/$opt.help`"
	else
	    echo "$opt"
	fi
    done
}

get_options() { # mod help list_options_to_add
    curopts=
    case $1 in
    all)
	REP=${PM2_ROOT}/config/options
	;;
    *)
	REP=${PM2_ROOT}/$1/config/options
	for opt in $3 `eval echo \\$$1` " "; do
	    case $opt in
	    \ )
		;;
	    *)
		case " $curopts " in
		*\ $opt\ *)
		    ;;
		*)
		    curopts="${curopts:+$curopts }$opt"
		    ;;
		esac
		;;
	    esac
	done
	;;
    esac

    if [ ! -d $REP ]; then
	return 0
    fi
    listopt=`(cd $REP ; ls *.sh) | sed -e 's,.sh,,'`
    listopt="`echo $listopt`"

    if [ -z "$listopt" ]; then
	return 0
    fi

    echo "*******************************"
    echo "$2 (type help for help)"
    echo "Permited options: $listopt"
    while : ; do
	echo "Current selection: $curopts"
	read i
	case "$i" in
	help)
	    echo
	    help_option
	    echo
	    echo "$2"
	    echo "Permited options: $listopt"
	    ;;
	help\ *)
	    opt="`echo $i | sed -e 's,^help ,,'`"
	    echo
	    if [ -f $REP/$opt.help ]; then
		echo -n "$opt: "
		cat $REP/$opt.help
	    else
		echo "$opt"
	    fi
	    echo
	    ;;
	clear)
	    curopts=
	    ;;
	add\ *)
	    options="`echo $i | sed -e 's,^add ,,'`"
	    for opt in $options " "; do
		case $opt in
		\ )
		    ;;
		*)
		    case " $curopts " in
		    *\ $opt\ *)
			;;
		    *)
			case " $listopt " in
			*\ $opt\ *)
			    curopts="${curopts:+$curopts }$opt"
			    ;;
			*)
			    echo "Unknown option $opt"
			esac
			;;
		    esac
		    ;;
		esac
	    done
	    ;;
	sub\ *)
	    options="`echo $i | sed -e 's,^sub ,,'`"
	    for opt in $options " "; do
		case $opt in
		\ )
		    ;;
		*)
		    case " $curopts " in
		    *\ $opt\ *)
			curopts=`echo "$curopts " | sed -e "s,$opt ,," -e 's, $,,'`
			;;
		    *)
			;;
		    esac
		    ;;
		esac
	    done  
	    ;;
	quit|exit|q)
	    break
	    ;;
	*)
	    options="$i"
	    for opt in $options " "; do
		case $opt in
		\ )
		    ;;
		*)
		    case " $curopts " in
		    *\ $opt\ *)
			curopts=`echo "$curopts " | sed -e "s,$opt ,," -e 's, $,,'`
			;;
		    *)
			case " $listopt " in
			*\ $opt\ *)
			    curopts="${curopts:+$curopts }$opt"
			    ;;
			*)
			    echo "Unknown option $opt"
			esac
			;;
		    esac
		    ;;
		esac
	    done
	    ;;
	esac
    done
    eval $1='"$curopts"'
}

show_selection() { # ok
    echo
    echo "*******************************"
    echo "Current settings:"
    echo "flavor name: $flavor"
    echo "builddir   : $builddir"
    echo "modules    : $modules"
    echo "extension  : $ext"
    echo "  Common options             : `echo $common`"
    for mod in $modules; do
	module="`echo $mod'             ' | cut -c-6`"
	echo "  Modules $module with options: `eval echo \\$$mod`"
    done
    echo
    if [ $1 = 1 ]; then
	echo "Correct [Y/n] ?"
	read i
	[ -z "$i" ] && i=Y
    else
	echo "Correct [y/N] ?"
	read i
	[ -z "$i" ] && i=N
    fi
    case "$i" in
    Y*|y*|O*|o*)
	return 0
	;;
    *)
	return 1
	;;
    esac
}

get_values() {
    fin=false
    listflavors="`(cd ${PM2_ROOT}/flavors; ls)`"
    listflavors=`echo ' '$listflavors' ' | sed -e 's, CVS , ,'`
    while [ $fin = false ]; do
	echo "================= Flavors edition/creation =================="
        echo "Existing flavors :"
	echo $listflavors
	echo
	echo "*******************************"
	get_value 1 flavor "Name of the flavor to edit/create"
	if [ -f ${PM2_CONFIG}/$flavor ]; then
	    . ${PM2_CONFIG}/$flavor
	    builddir=$PM2_BUILD
	    modules=$PM2_LIBS
	    ext=$PM2_EXT
	    mod="none"
	    while read i ; do
		case "$i" in
		\#\ Configuring\ *)
		    mod=`echo $i | sed -e 's,^# Configuring ,,'`
		    case $mod in
		    pm2|dsm|marcel|tbx|ntbx|mad1|mad2|common)
			;;
		    *)
			mod=none
			;;
		    esac
		    ;;
		\#\ Option\ *)
		    opt=`echo $i | sed -e 's,^# Option ,,'`
		    if [ -f ${PM2_ROOT}/$mod/config/options/$opt.sh ]; then
			eval $mod=\"\$$mod' $opt"'
		    fi
		    ;;
		esac
	    done < ${PM2_CONFIG}/$flavor
	else
	    builddir=$flavor
	    modules="pm2 dsm marcel mad1"
	    marcel="mono"
	    mad1="tcp"
	fi
	builddir="$builddir "
	if show_selection 0; then
	    break
	fi
	echo "*******************************"
	echo "Editing $flavor"
	echo "Tips:"
	echo "  You can abort at any time with C-c"
	echo "  Use _ to select an empty value"
	echo
	get_value 0 builddir "Directory for compiling"
	builddir="$builddir "
	get_value 0 ext "Extension added to libraries and binaries"
	get_modules
	get_options all "Options for all modules and applications"
	get_options common "Common options"
	for mod in $modules; do
	    get_options $mod "Options for modules $mod" "$all"
	done
	all=
	if show_selection 1; then
	    fin=true
	fi
    done
    mad="$mad1$mad2"
    mad1=
    mad2=
    all=
}

##########################################################################
##########################################################################
######################### NON INTERACTIVE PART ###########################
##########################################################################
##########################################################################

if test $# -eq 0; then
    usage 1
fi

flavor=
modules=
all=
common=
pm2=
marcel=
mad=
dsm=
protocols=
builddir=
ext=
delete=false
interactive=false

##########################################################################
# traitement des options
while test $# -gt 0; do
    case "$1" in
    -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
    *) optarg= ;;
    esac

    case "$1" in
    --version)
	echo pm2-libs 3.0
	exit 0
	;;
    --help)
	usage 0
	;;
    --interactive)
	interactive=true
	;;
    --delete)
	delete=true
	;;
    --all=*|--pm2=*|--marcel=*|--mad=*|--dsm=*|--common=*)
	optname=`echo $1 | sed -e 's/^--\([^=]*\)=.*$/\1/'`
	eval $optname=\"\$$optname' $optarg"'
	;;
    --modules=*|--protocols=*)
	optname=`echo $1 | sed -e 's/^--\([^=]*\)=.*$/\1/'`
	eval $optname=\"\$$optname' $optarg"'
	;;
    --ext=*)
	optname=`echo $1 | sed -e 's/^--\([^=]*\)=.*$/\1/'`
	eval $optname=\"\$$optname'$optarg"'
	;;
    --flavor=*|--builddir=*)
	optname=`echo $1 | sed -e 's/^--\([^=]*\)=.*$/\1/'`
	eval $optname='"$optarg"'
	;;	
    *)
	echo Unknown option \`$1\' 1>&2
	usage 1
	;;
    esac
    shift
done

##########################################################################
# usage interactif
if [ $interactive = true ]; then
    if [ -z "$flavor" ]; then
	flavor=default
    fi
    get_values
fi

if [ -z "$flavor" ]; then
    echo "no name"
    usage 1
fi

##########################################################################
# effacement d'une flavor
if [ "$delete" = true ]; then
    echo removing flavor $flavor
    make -C ${PM2_ROOT} FLAVOR=$flavor clean
    STAMP_REP=`pm2-config --flavor=$flavor --stampdir`
    BUILDDIR=`pm2-config --flavor=$flavor --builddir`
    PM2_EXT=`pm2-config --flavor=$flavor --ext`
    if [ -f "$STAMP_REP/stamp$PM2_EXT" ]; then
	rm -f "$STAMP_REP/stamp$PM2_EXT"
    fi
    if [ "$BUILDDIR" -a -d "$STAMP_REP" ]; then
	rmdir "$STAMP_REP"
    fi
    if [ -f "$PM2_CONFIG/$flavor" ]; then
	rm -f "$PM2_CONFIG/$flavor"
    fi
    exit 0
fi

##########################################################################
# choix par défaut et correction des grosses omissions
if [ -z "$builddir" ]; then
    builddir=$flavor
fi

PM2_BUILD=`echo $builddir`

# marcel doit être d'un des 4 types
case " $marcel $all " in
*\ mono\ *|*\ smp\ *|*\ act\ *|*\ actsmp\ *)
    ;;
*)
    marcel="$marcel mono"
    ;;
esac

old_mod="$modules"
modules=""
PM2_LIBS=""
MAD=
for mod in $old_mod " "; do
    case "$mod" in
    \ )
	;;
    pm2|marcel|dsm|tbx|ntbx)
	PM2_LIBS="${PM2_LIBS:+$PM2_LIBS }$mod"
	;;
    mad1)
	PM2_LIBS="${PM2_LIBS:+$PM2_LIBS }$mod"
	MAD=$mod
	# Madeleine doit avoit au moins un protocole (tcp par défaut)
	case " $mad $all " in
	*\ bip\ *|*\ mpi-bip\ *|*\ mpi-lam\ *|*\ mpi-sgi\ *|*\ mpi-sp2\ *)
	    ;;
	*\ pvm\ *|*\ sbp\ *|*\ shm\ *|*\ sisci\ *|*\ tcp\ *|*\ via\ *)
	    ;;
	*)
	    mad="$mad tcp"
	    ;;
	esac
	;;
    mad2)
	PM2_LIBS="${PM2_LIBS:+$PM2_LIBS }$mod"
	MAD=$mod
	# Madeleine doit avoit au moins un protocole (tcp par défaut)
	case " $mad $all " in
	*\ mpi\ *|*\ sbp\ *|*\ sisci\ *|*\ tcp\ *|*\ via\ *)
	    ;;
	*)
	    mad="$mad tcp"
	    ;;
	esac
	;;
    *)
	echo Unknown library \`$mod\' 1>&2
	exit 1
	;;
    esac
done

##########################################################################
# On vérifie qu'on existe pas déjà ou qu'une autre flavor se compile
# au même endroit
STAMPDIR=${PM2_ROOT}/stamp${PM2_BUILD:+/$PM2_BUILD}

if [ ! -d ${STAMPDIR} ]; then
    mkdir -p $STAMPDIR
fi

if [ -f ${STAMPDIR}/stamp$ext ]; then
    if [ "`cat ${STAMPDIR}/stamp$ext`" = "$flavor" ]; then
	echo modifying $flavor
    else
	echo 'Flavor `'"`cat ${STAMPDIR}/stamp$ext`"'` already use this repertory/extention'
	echo "Aborting..."
	echo 'If you know that flavor `'"`cat ${STAMPDIR}/stamp$ext`"'` does not exist'
	echo "then remove ${STAMPDIR}/stamp$ext"
	echo 'else remove it with `pm2_create-flavor --delete --flavor='"`cat ${STAMPDIR}/stamp$ext`"'`'
	exit 0
    fi
elif [ -f ${PM2_CONFIG}/$flavor ]; then
    echo "modifying $flavor and changing repertory/extention"
    echo "removing the old one"
    pm2_create-flavor --flavor=$flavor --delete || \
	( echo Error: aborting; exit 1 )
else
    echo "Creating flavor $flavor"
fi

##########################################################################
# Création réelle
ext=`echo $ext` #delete spaces
echo "PM2_BUILD=$PM2_BUILD" > ${PM2_CONFIG}/$flavor
echo "PM2_LIBS=\"$PM2_LIBS\"" >> ${PM2_CONFIG}/$flavor
echo "PM2_EXT=$ext" >> ${PM2_CONFIG}/$flavor

for mod in common $PM2_LIBS; do
    options="`eval echo \\$$mod` $all"
    case $mod in
    mad1|mad2)
	options="$options $mad"
	;;
    esac
    if [ "`echo $options | wc -w`" = 0 ]; then
	echo "# No option for $mod" >> ${PM2_CONFIG}/$flavor
    else
	echo "# Configuring $mod" >> ${PM2_CONFIG}/$flavor
	for opt in $options; do
	    if [ -f ${PM2_ROOT}/$mod/config/options/$opt.sh ]; then
		echo "# Option $opt" >> ${PM2_CONFIG}/$flavor
		cat ${PM2_ROOT}/$mod/config/options/$opt.sh \
		    >> ${PM2_CONFIG}/$flavor
	    else
		echo "# Option $opt not present" >> ${PM2_CONFIG}/$flavor
	    fi
	done
    fi
done

echo $flavor > ${STAMPDIR}/stamp$ext

exit 0



